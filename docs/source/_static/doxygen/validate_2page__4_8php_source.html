<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tripal Plant PopGen Submit: /var/www/html/sites/all/modules/TGDR/forms/validate/page_4.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tripal Plant PopGen Submit
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('validate_2page__4_8php_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">page_4.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="validate_2page__4_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160; </div>
<div class="line"><a name="l00016"></a><span class="lineno"><a class="line" href="validate_2page__4_8php.html#a9572a6c7fd517d3db39e822551142ef9">   16</a></span>&#160;<span class="keyword">function</span> <a class="code" href="validate_2page__4_8php.html#a9572a6c7fd517d3db39e822551142ef9">tpps_page_4_validate_form</a>(array &amp;$form, array &amp;$form_state) {</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; </div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;submitted&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    unset($form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>]);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160; </div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    $form_values = $form_state[<span class="stringliteral">&#39;values&#39;</span>];</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    $organism_number = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a>][<span class="stringliteral">&#39;organism&#39;</span>][<span class="stringliteral">&#39;number&#39;</span>];</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="keywordflow">for</span> ($i = 1; $i &lt;= $organism_number; $i++) {</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;      $organism = $form_values[<span class="stringliteral">&quot;organism-$i&quot;</span>];</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;      <span class="keywordflow">if</span> ($i &gt; 1 and isset($organism[<span class="stringliteral">&#39;phenotype-repeat-check&#39;</span>]) and $organism[<span class="stringliteral">&#39;phenotype-repeat-check&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        unset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>]);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;      }</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;      <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>])) {</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <a class="code" href="validate_2page__4_8php.html#a6d7de4f1dbe7b3c14bfb86231b8de7b2">tpps_validate_phenotype</a>($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>], $i, $form, $form_state);</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;      }</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160; </div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;      <span class="keywordflow">if</span> ($i &gt; 1 and isset($organism[<span class="stringliteral">&#39;genotype-repeat-check&#39;</span>]) and $organism[<span class="stringliteral">&#39;genotype-repeat-check&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        unset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>]);</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;      }</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;      <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>])) {</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        <a class="code" href="validate_2page__4_8php.html#ad613dde70484b7d5884470b3d7dded34">tpps_validate_genotype</a>($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>], $i, $form, $form_state);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;      }</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160; </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;      <span class="keywordflow">if</span> ($i &gt; 1 and isset($organism[<span class="stringliteral">&#39;environment-repeat-check&#39;</span>]) and $organism[<span class="stringliteral">&#39;environment-repeat-check&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        unset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>]);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      }</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;      <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>])) {</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <a class="code" href="validate_2page__4_8php.html#aa3f1c80bca794610888f67daa0449540">tpps_validate_environment</a>($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>], <span class="stringliteral">&quot;organism-$i&quot;</span>);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;      }</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">if</span> (form_get_errors() and !$form_state[<span class="stringliteral">&#39;rebuild&#39;</span>]) {</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;      $form_state[<span class="stringliteral">&#39;rebuild&#39;</span>] = TRUE;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;      $new_form = drupal_rebuild_form(<span class="stringliteral">&#39;tpps_main&#39;</span>, $form_state, $form);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;      <span class="keywordflow">for</span> ($i = 1; $i &lt;= $organism_number; $i++) {</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <span class="keywordflow">if</span> (isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>])) {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>];</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-phenotype-metadata-upload&quot;</span>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        }</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> (isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>])) {</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>];</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-phenotype-metadata-columns&quot;</span>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>])) {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>];</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>];</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-phenotype-file-upload&quot;</span>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-phenotype-file-columns&quot;</span>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        }</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>]) and isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>])) {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>];</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-genotype-files-snps-assay-upload&quot;</span>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>]) and isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>])) {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>];</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-genotype-files-snps-assay-columns&quot;</span>;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        }</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>]) and isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>])) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>];</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;upload&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-genotype-files-other-upload&quot;</span>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        }</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>]) and isset($new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>])) {</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>] = $new_form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>];</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;          $form[<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>][<span class="stringliteral">&#39;columns&#39;</span>][<span class="stringliteral">&#39;#id&#39;</span>] = <span class="stringliteral">&quot;edit-organism-$i-genotype-files-other-columns&quot;</span>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        }</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    }</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;}</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="validate_2page__4_8php.html#a6d7de4f1dbe7b3c14bfb86231b8de7b2">  105</a></span>&#160;<span class="keyword">function</span> <a class="code" href="validate_2page__4_8php.html#a6d7de4f1dbe7b3c14bfb86231b8de7b2">tpps_validate_phenotype</a>(array $phenotype, $org_num, array $form, array &amp;$form_state) {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  $iso_check = $phenotype[<span class="stringliteral">&#39;iso-check&#39;</span>];</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  $id = <span class="stringliteral">&quot;organism-$org_num&quot;</span>;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160; </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordflow">if</span> (empty($iso_check)) {</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    $phenotype_number = $phenotype[<span class="stringliteral">&#39;phenotypes-meta&#39;</span>][<span class="stringliteral">&#39;number&#39;</span>];</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    $phenotype_check = $phenotype[<span class="stringliteral">&#39;check&#39;</span>];</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    $phenotype_meta = $phenotype[<span class="stringliteral">&#39;metadata&#39;</span>];</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    $phenotype_file = $phenotype[<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">if</span> ($phenotype_check == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <span class="keywordflow">if</span> ($phenotype_meta == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][metadata&quot;</span>, <span class="stringliteral">&quot;Phenotype Metadata File: field is required.&quot;</span>);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        $required_groups = array(</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;          <span class="stringliteral">&#39;Phenotype Id&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            <span class="stringliteral">&#39;id&#39;</span> =&gt; array(1),</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;          ),</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;          <span class="stringliteral">&#39;Attribute&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            <span class="stringliteral">&#39;attr&#39;</span> =&gt; array(2),</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;          ),</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;          <span class="stringliteral">&#39;Description&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="stringliteral">&#39;desc&#39;</span> =&gt; array(3),</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;          ),</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;          <span class="stringliteral">&#39;Units&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            <span class="stringliteral">&#39;units&#39;</span> =&gt; array(4),</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;          ),</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        );</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        $file_element = $form[$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>];</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        $groups = <a class="code" href="file__utils_8inc.html#acedf90c1091e02904f2bd886b83640fe">tpps_file_validate_columns</a>($form_state, $required_groups, $file_element);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;          <span class="comment">// Get phenotype name column.</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;          $phenotype_name_col = $groups[<span class="stringliteral">&#39;Phenotype Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160; </div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;          <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;          $file = file_load($form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata&#39;</span>]);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;          file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;          $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Phenotype_Metadata_$org_num&quot;</span>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      }</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    }</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">for</span> ($i = 1; $i &lt;= $phenotype_number; $i++) {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      $current_phenotype = $phenotype[<span class="stringliteral">&#39;phenotypes-meta&#39;</span>][<span class="stringliteral">&quot;$i&quot;</span>];</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      $name = $current_phenotype[<span class="stringliteral">&#39;name&#39;</span>];</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      $attribute = $current_phenotype[<span class="stringliteral">&#39;attribute&#39;</span>];</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      $description = $current_phenotype[<span class="stringliteral">&#39;description&#39;</span>];</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      $units = $current_phenotype[<span class="stringliteral">&#39;units&#39;</span>];</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      <span class="keywordflow">if</span> ($name == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][name&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Name: field is required.&quot;</span>);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160; </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      <span class="keywordflow">if</span> ($attribute == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][attribute&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Attribute: field is required.&quot;</span>);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      <span class="keywordflow">if</span> ($description == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][description&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Description: field is required.&quot;</span>);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      <span class="keywordflow">if</span> ($units == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][units&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Units: field is required.&quot;</span>);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      <span class="keywordflow">if</span> ($current_phenotype[<span class="stringliteral">&#39;struct-check&#39;</span>] == <span class="charliteral">&#39;1&#39;</span> and $current_phenotype[<span class="stringliteral">&#39;structure&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][structure&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Structure: field is required.&quot;</span>);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      }</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      <span class="keywordflow">if</span> (($current_phenotype[<span class="stringliteral">&#39;val-check&#39;</span>] or $current_phenotype[<span class="stringliteral">&#39;bin-check&#39;</span>]) and $current_phenotype[<span class="stringliteral">&#39;min&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][min&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Minimum Value: field is required.&quot;</span>);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      <span class="keywordflow">if</span> (($current_phenotype[<span class="stringliteral">&#39;val-check&#39;</span>] or $current_phenotype[<span class="stringliteral">&#39;bin-check&#39;</span>]) and $current_phenotype[<span class="stringliteral">&#39;max&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][max&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Maximum Value: field is required.&quot;</span>);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      <span class="keywordflow">if</span> ($current_phenotype[<span class="stringliteral">&#39;time-check&#39;</span>] == <span class="charliteral">&#39;1&#39;</span> and $current_phenotype[<span class="stringliteral">&#39;time&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][phenotypes-meta][$i][time&quot;</span>, <span class="stringliteral">&quot;Phenotype $i Time: field is required.&quot;</span>);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      }</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordflow">if</span> ($phenotype_file == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][phenotype][file&quot;</span>, <span class="stringliteral">&quot;Phenotypes: field is required.&quot;</span>);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      <span class="keywordflow">if</span> ($phenotype[<span class="stringliteral">&#39;format&#39;</span>] == 0) {</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        $required_groups = array(</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;          <span class="stringliteral">&#39;Tree Identifier&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            <span class="stringliteral">&#39;id&#39;</span> =&gt; array(1),</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;          ),</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;          <span class="stringliteral">&#39;Phenotype Data&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            <span class="stringliteral">&#39;phenotype-data&#39;</span> =&gt; array(0),</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;          ),</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        );</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        $required_groups = array(</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;          <span class="stringliteral">&#39;Tree Identifier&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <span class="stringliteral">&#39;id&#39;</span> =&gt; array(1),</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;          ),</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;          <span class="stringliteral">&#39;Phenotype Name/Identifier&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="stringliteral">&#39;phenotype-name&#39;</span> =&gt; array(2),</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;          ),</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;          <span class="stringliteral">&#39;Phenotype Value(s)&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            <span class="stringliteral">&#39;val&#39;</span> =&gt; array(3),</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;          ),</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        );</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      }</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      $file_element = $form[$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      $groups = <a class="code" href="file__utils_8inc.html#acedf90c1091e02904f2bd886b83640fe">tpps_file_validate_columns</a>($form_state, $required_groups, $file_element);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        $phenotype_file_tree_col = $groups[<span class="stringliteral">&#39;Tree Identifier&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        $phenotype_names = array();</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">if</span> ($phenotype[<span class="stringliteral">&#39;format&#39;</span>] == 0) {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;          $phenotype_file_name_cols = $groups[<span class="stringliteral">&#39;Phenotype Data&#39;</span>][<span class="charliteral">&#39;0&#39;</span>];</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;          $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($phenotype_file, !empty($phenotype[<span class="stringliteral">&#39;file-no-header&#39;</span>]));</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;          <span class="keywordflow">foreach</span> ($phenotype_file_name_cols as $column_index) {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            $phenotype_names[] = $headers[$column_index];</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;          }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        }</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;          $phenotype_file_name_col = $groups[<span class="stringliteral">&#39;Phenotype Name/Identifier&#39;</span>][<span class="charliteral">&#39;2&#39;</span>];</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;          $phenotype_names = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($phenotype_file, $phenotype_file_name_col);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        }</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        $phenotype_meta_names = array();</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">if</span> (isset($phenotype_name_col)) {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;          $phenotype_meta_names = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($phenotype_meta, $phenotype_name_col);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        }</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160; </div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">for</span> ($i = 1; $i &lt;= $phenotype_number; $i++) {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;          $phenotype_meta_names[] = $phenotype[<span class="stringliteral">&#39;phenotypes-meta&#39;</span>][$i][<span class="stringliteral">&#39;name&#39;</span>];</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160; </div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        $missing_phenotypes = array_diff($phenotype_names, $phenotype_meta_names);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">if</span> (!empty($missing_phenotypes)) {</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;          $phenotype_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_phenotypes);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][phenotype][file&quot;</span>, <span class="stringliteral">&quot;Phenotype file: We detected Phenotypes that were not in your Phenotype Metadata file. Please either remove these phenotypes from your Phenotype file, or add them to your Phenotype Metadata file. The phenotypes we detected with missing definitions were: $phenotype_id_str&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        }</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">if</span> (isset($phenotype_file_tree_col)) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;          $species_index = <span class="stringliteral">&quot;species-$org_num&quot;</span>;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;          <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            $species_index = <span class="stringliteral">&quot;species-1&quot;</span>;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;          }</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;          $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;          $column_vals = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-columns&#39;</span>];</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;          <span class="keywordflow">foreach</span> ($column_vals as $col =&gt; $val) {</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            <span class="keywordflow">if</span> ($val == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;              $id_col_accession_name = $col;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;          }</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;          $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;          $phenotype_no_header = $form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;          $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>], $tree_accession_file, $phenotype_file_tree_col, $id_col_accession_name, $phenotype_no_header, $acc_no_header);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;          <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][phenotype][file&quot;</span>, <span class="stringliteral">&quot;Phenotype file: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your Phenotype file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;          }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        $file = file_load($form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;file&#39;</span>]);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Phenotype_Data_$org_num&quot;</span>;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      }</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($phenotype[<span class="stringliteral">&#39;iso&#39;</span>]);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    $id_col_name = key($headers);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">while</span> (($k = array_search(NULL, $headers))) {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      unset($headers[$k]);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    $num_columns = <a class="code" href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a>($phenotype[<span class="stringliteral">&#39;iso&#39;</span>]) - 1;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    $num_unique_columns = count(array_unique($headers)) - 1;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160; </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">if</span> ($num_unique_columns != $num_columns) {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][phenotype][iso&quot;</span>, <span class="stringliteral">&quot;Mass spectrometry/Isotope file: some columns in the file you provided are missing or have duplicate header values. Please either enter valid header values for those columns or remove those columns, then reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      $species_index = <span class="stringliteral">&quot;species-$org_num&quot;</span>;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        $species_index = <span class="stringliteral">&quot;species-1&quot;</span>;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      }</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      $id_col_accession_name = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-groups&#39;</span>][<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($phenotype[<span class="stringliteral">&#39;iso&#39;</span>], $tree_accession_file, $id_col_name, $id_col_accession_name, FALSE, $acc_no_header);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;      <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][phenotype][iso&quot;</span>, <span class="stringliteral">&quot;Mass spectrometry/Isotope file: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    }</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      $file = file_load($phenotype[<span class="stringliteral">&#39;iso&#39;</span>]);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Phenotype_Data_$org_num&quot;</span>;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    }</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  }</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;}</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160; </div>
<div class="line"><a name="l00336"></a><span class="lineno"><a class="line" href="validate_2page__4_8php.html#ad613dde70484b7d5884470b3d7dded34">  336</a></span>&#160;<span class="keyword">function</span> <a class="code" href="validate_2page__4_8php.html#ad613dde70484b7d5884470b3d7dded34">tpps_validate_genotype</a>(array $genotype, $org_num, array $form, array &amp;$form_state) {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  $id = <span class="stringliteral">&quot;organism-$org_num&quot;</span>;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  $snps = $genotype[<span class="stringliteral">&#39;SNPs&#39;</span>];</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  $ref_genome = $genotype[<span class="stringliteral">&#39;ref-genome&#39;</span>];</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  $file_type = $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;file-type&#39;</span>];</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  $vcf = isset($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;vcf&#39;</span>]) ? $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;vcf&#39;</span>] : 0;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  $snps_assay = isset($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>]) ? $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-assay&#39;</span>] : 0;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  $assoc_file = $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-association&#39;</span>] ?? 0;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  $other_file = isset($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>]) ? $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>] : 0;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordflow">if</span> (!$ref_genome) {</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][ref-genome&quot;</span>, <span class="stringliteral">&quot;Reference Genome: field is required.&quot;</span>);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  elseif ($ref_genome === <span class="stringliteral">&#39;bio&#39;</span>) {</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">if</span> (!$genotype[<span class="stringliteral">&#39;tripal_eutils&#39;</span>][<span class="stringliteral">&#39;accession&#39;</span>]) {</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_eutils][accession&quot;</span>, <span class="stringliteral">&#39;NCBI Accession Number: field is required.&#39;</span>);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    }</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    $connection = new \EUtils();</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      $connection-&gt;setPreview();</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      $parsed = $connection-&gt;get($genotype[<span class="stringliteral">&#39;tripal_eutils&#39;</span>][<span class="stringliteral">&#39;db&#39;</span>], $genotype[<span class="stringliteral">&#39;tripal_eutils&#39;</span>][<span class="stringliteral">&#39;accession&#39;</span>]);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      <span class="keywordflow">foreach</span> ($_SESSION[<span class="stringliteral">&#39;messages&#39;</span>][<span class="stringliteral">&#39;status&#39;</span>] as $key =&gt; $message) {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">if</span> ($message == <span class="stringliteral">&#39;&lt;pre&gt;biosample&lt;/pre&gt;&#39;</span>) {</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;          unset($_SESSION[<span class="stringliteral">&#39;messages&#39;</span>][<span class="stringliteral">&#39;status&#39;</span>][$key]);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;          <span class="keywordflow">if</span> (empty($_SESSION[<span class="stringliteral">&#39;messages&#39;</span>][<span class="stringliteral">&#39;status&#39;</span>])) {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            unset($_SESSION[<span class="stringliteral">&#39;messages&#39;</span>][<span class="stringliteral">&#39;status&#39;</span>]);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          }</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        }</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;      }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;parsed&#39;</span>] = $parsed;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    }</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">catch</span> (\Exception $e) {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_eutils][accession&quot;</span>, $e-&gt;getMessage());</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    }</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">/*if (!$genotype[&#39;BioProject-id&#39;]) {</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">      form_set_error(&quot;$id][genotype][Bioproject-id&quot;, &#39;BioProject Id: field is required.&#39;);</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">    else {</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">      $assembly_auto_check = &#39;&#39;;</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">      foreach ($genotype[&#39;assembly-auto&#39;] as $item) {</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">        $assembly_auto_check += $item;</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">      if (preg_match(&#39;/^0*$/&#39;, $assembly_auto_check)) {</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">        form_set_error(&quot;$id][genotype][assembly-auto&quot;, &#39;Assembly file(s): field is required.&#39;);</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">    }*/</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  elseif ($ref_genome === <span class="stringliteral">&#39;url&#39;</span> or $ref_genome === <span class="stringliteral">&#39;manual&#39;</span> or $ref_genome === <span class="stringliteral">&#39;manual2&#39;</span>) {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    $class = <span class="stringliteral">&#39;FASTAImporter&#39;</span>;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    tripal_load_include_importer_class($class);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    $fasta_vals = $genotype[<span class="stringliteral">&#39;tripal_fasta&#39;</span>];</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160; </div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    $file_upload = isset($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_upload&#39;</span>]) ? trim($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_upload&#39;</span>]) : 0;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    $file_existing = isset($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_upload_existing&#39;</span>]) ? trim($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_upload_existing&#39;</span>]) : 0;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    $file_remote = isset($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_remote&#39;</span>]) ? trim($fasta_vals[<span class="stringliteral">&#39;file&#39;</span>][<span class="stringliteral">&#39;file_remote&#39;</span>]) : 0;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    $db_id = trim($fasta_vals[<span class="stringliteral">&#39;db&#39;</span>][<span class="stringliteral">&#39;db_id&#39;</span>]);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    $re_accession = trim($fasta_vals[<span class="stringliteral">&#39;db&#39;</span>][<span class="stringliteral">&#39;re_accession&#39;</span>]);</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    $analysis_id = trim($fasta_vals[<span class="stringliteral">&#39;analysis_id&#39;</span>]);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    $seqtype = trim($fasta_vals[<span class="stringliteral">&#39;seqtype&#39;</span>]);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160; </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">if</span> (!$file_upload and !$file_existing and !$file_remote) {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_fasta][file&quot;</span>, <span class="stringliteral">&quot;Assembly file: field is required.&quot;</span>);</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    }</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160; </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    $re_name = <span class="stringliteral">&#39;^(.*?)\s.*$&#39;</span>;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160; </div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">if</span> ($db_id and !$re_accession) {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_fasta][additional][re_accession&quot;</span>, <span class="stringliteral">&#39;Accession regular expression: field is required.&#39;</span>);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">if</span> ($re_accession and !$db_id) {</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_fasta][additional][db_id&quot;</span>, <span class="stringliteral">&#39;External Database: field is required.&#39;</span>);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    }</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span> (!$analysis_id) {</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_fasta][analysis_id&quot;</span>, <span class="stringliteral">&#39;Analysis: field is required.&#39;</span>);</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    }</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">if</span> (!$seqtype) {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][tripal_fasta][seqtype&quot;</span>, <span class="stringliteral">&#39;Sequence Type: field is required.&#39;</span>);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    }</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">// dpm($class::$file_required);</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">// dpm($fasta_vals);</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="comment">// form_set_error(&quot;Submit&quot;, &#39;error&#39;);.</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;      $assembly = $file_existing ? $file_existing : ($file_upload ? $file_upload : $file_remote);</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    }</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  }</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160; </div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordflow">if</span> (implode(<span class="stringliteral">&#39;&#39;</span>, $genotype[<span class="stringliteral">&#39;marker-type&#39;</span>]) === <span class="stringliteral">&#39;000&#39;</span>) {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][marker-type&quot;</span>, <span class="stringliteral">&quot;Genotype Marker Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  }</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  elseif ($genotype[<span class="stringliteral">&#39;marker-type&#39;</span>][<span class="stringliteral">&#39;SNPs&#39;</span>]) {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordflow">if</span> (!$snps[<span class="stringliteral">&#39;genotyping-design&#39;</span>]) {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][SNPs][genotyping-design&quot;</span>, <span class="stringliteral">&quot;Genotyping Design: field is required.&quot;</span>);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    }</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    elseif ($snps[<span class="stringliteral">&#39;genotyping-design&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      <span class="keywordflow">if</span> (!$snps[<span class="stringliteral">&#39;GBS&#39;</span>]) {</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][SNPs][GBS&quot;</span>, <span class="stringliteral">&quot;GBS Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      elseif ($snps[<span class="stringliteral">&#39;GBS&#39;</span>] == <span class="charliteral">&#39;5&#39;</span> and !$snps[<span class="stringliteral">&#39;GBS-other&#39;</span>]) {</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][SNPs][GBS=other&quot;</span>, <span class="stringliteral">&quot;Custom GBS Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    elseif ($snps[<span class="stringliteral">&#39;genotyping-design&#39;</span>] == <span class="charliteral">&#39;2&#39;</span>) {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordflow">if</span> (!$snps[<span class="stringliteral">&#39;targeted-capture&#39;</span>]) {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][SNPs][targeted-capture&quot;</span>, <span class="stringliteral">&quot;Targeted Capture: field is required.&quot;</span>);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;      }</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      elseif ($snps[<span class="stringliteral">&#39;targeted-capture&#39;</span>] == <span class="charliteral">&#39;2&#39;</span> and !$snps[<span class="stringliteral">&#39;targeted-capture-other&#39;</span>]) {</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][SNPs][targeted-capture-other&quot;</span>, <span class="stringliteral">&quot;Custom Targeted Capture: field is required.&quot;</span>);</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    }</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  }</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  elseif ($genotype[<span class="stringliteral">&#39;marker-type&#39;</span>][<span class="stringliteral">&#39;SSRs/cpSSRs&#39;</span>] and empty($genotype[<span class="stringliteral">&#39;SSRs/cpSSRs&#39;</span>])) {</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][SSRs/cpSSRs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs: field is required.&quot;</span>);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  }</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  elseif ($genotype[<span class="stringliteral">&#39;marker-type&#39;</span>][<span class="stringliteral">&#39;SSRs/cpSSRs&#39;</span>] and empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ploidy&#39;</span>])) {</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ploidy&quot;</span>, <span class="stringliteral">&quot;Ploidy: field is required.&quot;</span>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  }</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  elseif ($genotype[<span class="stringliteral">&#39;marker-type&#39;</span>][<span class="stringliteral">&#39;Other&#39;</span>] and empty($genotype[<span class="stringliteral">&#39;other-marker&#39;</span>])) {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][other-marker&quot;</span>, <span class="stringliteral">&quot;Other Genotype marker: field is required.&quot;</span>);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  }</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160; </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^0+$/&#39;</span>, implode(<span class="stringliteral">&#39;&#39;</span>, $file_type))) {</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][genotype][files][file-type&quot;</span>, <span class="stringliteral">&quot;Genotype File Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  }</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;VCF&#39;</span>]) and !$vcf) {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][vcf&quot;</span>, <span class="stringliteral">&quot;Genotype VCF File: field is required.&quot;</span>);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;VCF&#39;</span>])) {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keywordflow">if</span> (($ref_genome === <span class="stringliteral">&#39;manual&#39;</span> or $ref_genome === <span class="stringliteral">&#39;manual2&#39;</span> or $ref_genome === <span class="stringliteral">&#39;url&#39;</span>) and isset($assembly) and $assembly and !form_get_errors()) {</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        $vcf_content = fopen(file_load($vcf)-&gt;uri, <span class="charliteral">&#39;r&#39;</span>);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        $assembly_content = fopen(file_load($assembly)-&gt;uri, <span class="charliteral">&#39;r&#39;</span>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">while</span> (($vcf_line = fgets($vcf_content)) !== FALSE) {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;          <span class="keywordflow">if</span> ($vcf_line[0] != <span class="charliteral">&#39;#&#39;</span>) {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160; </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            $vcf_values = explode(<span class="stringliteral">&quot;\t&quot;</span>, $vcf_line);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            $scaffold_id = $vcf_values[0];</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            $match = FALSE;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            <span class="keywordflow">while</span> (($assembly_line = fgets($assembly_content)) !== FALSE) {</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;              <span class="keywordflow">if</span> ($assembly_line[0] != <span class="charliteral">&#39;&gt;&#39;</span>) {</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;              }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;              <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(.*?)\s.*$/&#39;</span>, $assembly_line, $matches)) {</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                  $assembly_scaffold = $matches[1];</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                }</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                <span class="keywordflow">if</span> ($assembly_scaffold[0] == <span class="charliteral">&#39;&gt;&#39;</span>) {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                  $assembly_scaffold = substr($assembly_scaffold, 1);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                <span class="keywordflow">if</span> ($assembly_scaffold == $scaffold_id) {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                  $match = TRUE;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;              }</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            }</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            <span class="keywordflow">if</span> (!$match) {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;              fclose($assembly_content);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;              $assembly_content = fopen(file_load($assembly)-&gt;uri, <span class="charliteral">&#39;r&#39;</span>);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;              <span class="keywordflow">while</span> (($assembly_line = fgets($assembly_content)) !== FALSE) {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                <span class="keywordflow">if</span> ($assembly_line[0] != <span class="charliteral">&#39;&gt;&#39;</span>) {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                  <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                }</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                  <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^(.*?)\s.*$/&#39;</span>, $assembly_line, $matches)) {</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                    $assembly_scaffold = $matches[1];</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                  }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                  <span class="keywordflow">if</span> ($assembly_scaffold[0] == <span class="charliteral">&#39;&gt;&#39;</span>) {</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                    $assembly_scaffold = substr($assembly_scaffold, 1);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                  }</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                  <span class="keywordflow">if</span> ($assembly_scaffold == $scaffold_id) {</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                    $match = TRUE;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                  }</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                }</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;              }</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;            }</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160; </div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            <span class="keywordflow">if</span> (!$match) {</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;              form_set_error(<span class="stringliteral">&quot;$id][genotype][files][vcf&quot;</span>, <span class="stringliteral">&quot;VCF File: scaffold $scaffold_id not found in assembly file(s)&quot;</span>);</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            }</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;          }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        }</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160; </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;      }</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160; </div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        $form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;vcf_genotype_count&#39;</span>] = <a class="code" href="file__utils_8inc.html#a4ea01f157958a5f304919c60cf04e84d">tpps_file_len</a>($vcf);</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      }</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160; </div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        $file = file_load($vcf);</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_VCF_$org_num&quot;</span>;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    }</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160; </div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;SNPs Genotype Assay&#39;</span>]) and !$snps_assay) {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-assay&quot;</span>, <span class="stringliteral">&quot;SNPs Assay file: field is required.&quot;</span>);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    }</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;SNPs Genotype Assay&#39;</span>])) {</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($snps_assay);</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      $id_col_name = key($headers);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="keywordflow">while</span> (($k = array_search(NULL, $headers))) {</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        unset($headers[$k]);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      }</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      $num_columns = <a class="code" href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a>($snps_assay) - 1;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      $num_unique_columns = count(array_unique($headers)) - 1;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; </div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="keywordflow">if</span> ($num_unique_columns != $num_columns) {</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-assay&quot;</span>, <span class="stringliteral">&quot;SNPs Assay file: some columns in the file you provided are missing or have duplicate header values. Please either enter valid header values for those columns or remove those columns, then reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;      }</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160; </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;          $species_index = <span class="stringliteral">&#39;species-1&#39;</span>;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        }</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;          $num = substr($id, 9);</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;          $species_index = <span class="stringliteral">&quot;species-$num&quot;</span>;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        }</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        $id_col_accession_name = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-groups&#39;</span>][<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160; </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($snps_assay, $tree_accession_file, $id_col_name, $id_col_accession_name, FALSE, $acc_no_header);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160; </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;          $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-assay&quot;</span>, <span class="stringliteral">&quot;SNPs Assay file: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your Genotype file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        }</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      }</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160; </div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        $file = file_load($snps_assay);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_SNPs_Assay_$org_num&quot;</span>;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      }</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160; </div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;SNPs Associations&#39;</span>]) and !$assoc_file) {</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association&quot;</span>, <span class="stringliteral">&quot;SNPs Associations file: field is required.&quot;</span>);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        }</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        elseif (!empty($file_type[<span class="stringliteral">&#39;SNPs Associations&#39;</span>])) {</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;          $required_groups = array(</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            <span class="stringliteral">&#39;SNP ID&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;              <span class="stringliteral">&#39;id&#39;</span> =&gt; array(1),</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            ),</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="stringliteral">&#39;Scaffold&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;              <span class="stringliteral">&#39;scaffold&#39;</span> =&gt; array(2),</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            ),</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            <span class="stringliteral">&#39;Position&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;              <span class="stringliteral">&#39;position&#39;</span> =&gt; array(3),</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;            ),</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <span class="stringliteral">&#39;Allele&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;              <span class="stringliteral">&#39;allele&#39;</span> =&gt; array(4),</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            ),</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            <span class="stringliteral">&#39;Associated Trait&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;              <span class="stringliteral">&#39;trait&#39;</span> =&gt; array(5),</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            ),</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="stringliteral">&#39;Confidence Value&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;              <span class="stringliteral">&#39;confidence&#39;</span> =&gt; array(6),</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            ),</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          );</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160; </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;          $file_element = $form[$id][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-association&#39;</span>];</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          $groups = <a class="code" href="file__utils_8inc.html#acedf90c1091e02904f2bd886b83640fe">tpps_file_validate_columns</a>($form_state, $required_groups, $file_element);</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160; </div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;          <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="comment">// Check that SNP IDs match Genotype Assay.</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            $snps_id_col = $groups[<span class="stringliteral">&#39;SNP ID&#39;</span>][1];</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            $assoc_no_header = $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-association-no-header&#39;</span>] ?? FALSE;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160; </div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            $assay_snps = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($snps_assay);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            unset($assay_snps[key($assay_snps)]);</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            $assoc_snps = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($assoc_file, $snps_id_col, $assoc_no_header);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            $missing_snps = array_diff($assoc_snps, $assay_snps);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160; </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            <span class="keywordflow">if</span> ($missing_snps !== array()) {</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;              $snps_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_snps);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;              form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association&quot;</span>, <span class="stringliteral">&quot;SNPs Association File: We detected SNP IDs that were not in your Genotype Assay. Please either remove these SNPs from your Association file, or add them to your Genotype Assay. The SNP Identifiers we found were: $snps_id_str&quot;</span>);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160; </div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="comment">// Check that Phenotype names match phenotype metadata section.</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            $trait_id_col = $groups[<span class="stringliteral">&#39;Associated Trait&#39;</span>][5];</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            $association_phenotypes = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($assoc_file, $trait_id_col, $assoc_no_header);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; </div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            $phenotype = $form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>];</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            $phenotype_meta = $phenotype[<span class="stringliteral">&#39;metadata&#39;</span>];</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            $phenotype_number = $phenotype[<span class="stringliteral">&#39;phenotypes-meta&#39;</span>][<span class="stringliteral">&#39;number&#39;</span>];</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160; </div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            $phenotype_meta_names = array();</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            $phenotype_name_col = $form_state[<span class="stringliteral">&#39;values&#39;</span>][$id][<span class="stringliteral">&#39;phenotype&#39;</span>][<span class="stringliteral">&#39;metadata-groups&#39;</span>][<span class="stringliteral">&#39;Phenotype Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>] ?? NULL;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="keywordflow">if</span> (isset($phenotype_name_col)) {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;              $phenotype_meta_names = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($phenotype_meta, $phenotype_name_col);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            }</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160; </div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordflow">for</span> ($i = 1; $i &lt;= $phenotype_number; $i++) {</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;              $phenotype_meta_names[] = $phenotype[<span class="stringliteral">&#39;phenotypes-meta&#39;</span>][$i][<span class="stringliteral">&#39;name&#39;</span>];</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;            }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160; </div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            $missing_phenotypes = array_diff($association_phenotypes, $phenotype_meta_names);</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            <span class="keywordflow">if</span> ($missing_phenotypes !== array()) {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;              $phenotype_names_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_phenotypes);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;              form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association&quot;</span>, <span class="stringliteral">&quot;SNPs Association File: We detected Associated Traits that were not specified in the Phenotype Metadata Section. Please either remove these Traits from your Association file, or add them to your Phenotype Metadata section. The Trait names we foud were: $phenotype_names_str&quot;</span>);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            }</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160; </div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            <span class="comment">// Check that position values are correctly formatted</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            $position_col = $groups[<span class="stringliteral">&#39;Position&#39;</span>][3];</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            $positions = <a class="code" href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a>($assoc_file, $position_col, $assoc_no_header);</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <span class="keywordflow">foreach</span> ($positions as $position) {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;              <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;/^(\d+):(\d+)$/&#39;</span>, $position)) {</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association&quot;</span>, <span class="stringliteral">&quot;SNPs Association File: We detected SNP positions that do not match the required format. The correct format is: \&quot;start:stop\&quot;.&quot;</span>);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;              }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            }</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;          }</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160; </div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;          <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            $file = file_load($assoc_file);</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;SNPs_Association_$org_num&quot;</span>;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;          }</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160; </div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          <span class="keywordflow">if</span> (empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-association-type&#39;</span>])) {</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association-type&quot;</span>, <span class="stringliteral">&quot;SNPs Association Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;          }</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160; </div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;          <span class="keywordflow">if</span> (empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-association-tool&#39;</span>])) {</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][snps-association-tool&quot;</span>, <span class="stringliteral">&quot;SNPs Association Tool: field is required.&quot;</span>);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;          }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;          <span class="keywordflow">if</span> (!form_get_errors() and !empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-pop-struct&#39;</span>])) {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            $file = file_load($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-pop-struct&#39;</span>]);</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;SNPs_Population_Structure_$org_num&quot;</span>;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;          }</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160; </div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;          <span class="keywordflow">if</span> (!form_get_errors() and !empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-kinship&#39;</span>])) {</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            $file = file_load($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;snps-kinship&#39;</span>]);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;SNPs_Population_Structure_$org_num&quot;</span>;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;          }</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      }</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    }</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160; </div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;Assay Design&#39;</span>]) and !$genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;assay-design&#39;</span>]) {</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][assay-design&quot;</span>, <span class="stringliteral">&quot;Assay Design file: field is required.&quot;</span>);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    }</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;Assay Design&#39;</span>]) and !form_get_errors()) {</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;      $file = file_load($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;assay-design&#39;</span>]);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_Assay_Design_$org_num&quot;</span>;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    }</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160; </div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;SSRs/cpSSRs Genotype Spreadsheet&#39;</span>]) and !$genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs&#39;</span>]) {</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs]&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Spreadsheet: field is required.&quot;</span>);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    }</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;SSRs/cpSSRs Genotype Spreadsheet&#39;</span>]) and !empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ploidy&#39;</span>])) {</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs&#39;</span>]);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      $id_col_name = key($headers);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;      <span class="keywordflow">while</span> (($k = array_search(NULL, $headers))) {</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        unset($headers[$k]);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;      }</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;      $num_columns = <a class="code" href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs&#39;</span>]) - 1;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;      $num_unique_columns = count(array_unique($headers)) - 1;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;      <span class="keywordflow">switch</span> ($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ploidy&#39;</span>]) {</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="keywordflow">case</span> <span class="stringliteral">&#39;Haploid&#39;</span>:</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;          <span class="keywordflow">if</span> ($num_unique_columns != $num_columns) {</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Genotype Spreadsheet: some columns in the file you provided are missing or have duplicate header values. Please either enter header values for those columns or remove those columns, then reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;          }</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160; </div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        <span class="keywordflow">case</span> <span class="stringliteral">&#39;Diploid&#39;</span>:</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;          <span class="keywordflow">if</span> ($num_unique_columns != $num_columns and $num_columns / $num_unique_columns !== 2) {</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;          }</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;          elseif ($num_unique_columns == $num_columns and $num_columns % 2 !== 0) {</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;          }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="keywordflow">case</span> <span class="stringliteral">&#39;Polyploid&#39;</span>:</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;          <span class="keywordflow">if</span> ($num_columns % $num_unique_columns !== 0) {</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;          }</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;      }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160; </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      <span class="keywordflow">if</span> (!empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssr-extra-check&#39;</span>])) {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keywordflow">if</span> (empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;extra-ssr-type&#39;</span>])) {</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][extra-ssr-type&quot;</span>, <span class="stringliteral">&quot;Define Additional SSRs/cpSSRs Type: field is required.&quot;</span>);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        }</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160; </div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordflow">if</span> (!$genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs_extra&#39;</span>]) {</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs_extra]&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Additional Spreadsheet: field is required.&quot;</span>);</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        }</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        elseif (!empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;extra-ploidy&#39;</span>])) {</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;          $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs_extra&#39;</span>]);</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;          $id_col_name = key($headers);</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;          <span class="keywordflow">while</span> (($k = array_search(NULL, $headers))) {</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;            unset($headers[$k]);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;          }</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;          $num_columns = <a class="code" href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs_extra&#39;</span>]) - 1;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;          $num_unique_columns = count(array_unique($headers)) - 1;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160; </div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          <span class="keywordflow">switch</span> ($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;extra-ploidy&#39;</span>]) {</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;Haploid&#39;</span>:</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;              <span class="keywordflow">if</span> ($num_unique_columns != $num_columns) {</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs_extra&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Additional Genotype Spreadsheet: some columns in the file you provided are missing or have duplicate header values. Please either enter header values for those columns or remove those columns, then reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;              }</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160; </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;Diploid&#39;</span>:</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;              <span class="keywordflow">if</span> ($num_unique_columns != $num_columns and $num_columns / $num_unique_columns !== 2) {</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs_extra&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Additional Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;              }</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;              elseif ($num_unique_columns == $num_columns and $num_columns % 2 !== 0) {</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs_extra&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Additional Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;              }</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160; </div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            <span class="keywordflow">case</span> <span class="stringliteral">&#39;Polyploid&#39;</span>:</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;              <span class="keywordflow">if</span> ($num_columns % $num_unique_columns !== 0) {</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs_extra&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Additional Genotype Spreadsheet: There is either an invalid number of columns in your file, or some of your columns are missing values. Please review and reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;              }</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160; </div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;              <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;          }</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        }</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;      }</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160; </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        $species_index = <span class="stringliteral">&quot;species-$org_num&quot;</span>;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;          $species_index = <span class="stringliteral">&quot;species-1&quot;</span>;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        $id_col_accession_name = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-groups&#39;</span>][<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160; </div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs&#39;</span>], $tree_accession_file, $id_col_name, $id_col_accession_name, FALSE, $acc_no_header);</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160; </div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;          $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][ssrs&quot;</span>, <span class="stringliteral">&quot;SSRs/cpSSRs Genotype Spreadsheet: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your Genotype file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        }</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160; </div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        $file = file_load($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs&#39;</span>]);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_SSR_Spreadsheet_$org_num&quot;</span>;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <span class="keywordflow">if</span> (!empty($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs_extra&#39;</span>])) {</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;          $file = file_load($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;ssrs_extra&#39;</span>]);</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;          file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;          $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_SSR_Additional_Spreadsheet_$org_num&quot;</span>;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        }</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      }</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    }</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160; </div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;Indel Genotype Spreadsheet&#39;</span>]) and !$genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;indels&#39;</span>]) {</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][indels]&quot;</span>, <span class="stringliteral">&quot;Indel Genotype Spreadsheet: field is required.&quot;</span>);</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    }</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;Indel Genotype Spreadsheet&#39;</span>])) {</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;      $indel_fid = $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;indels&#39;</span>];</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($indel_fid);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;      $id_col_name = key($headers);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;      <span class="keywordflow">while</span> (($k = array_search(NULL, $headers))) {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        unset($headers[$k]);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      }</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      $num_columns = <a class="code" href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a>($indel_fid) - 1;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      $num_unique_columns = count(array_unique($headers)) - 1;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160; </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      <span class="keywordflow">if</span> ($num_unique_columns != $num_columns) {</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        form_set_error(<span class="stringliteral">&quot;$id][genotype][files][indels&quot;</span>, <span class="stringliteral">&quot;Indel Genotype Spreadsheet: some columns in the file you provided are missing or have duplicate header values. Please either enter valid header values for those columns or remove those columns, then reupload your file.&quot;</span>);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160; </div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;          $species_index = <span class="stringliteral">&#39;species-1&#39;</span>;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        }</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;          $num = substr($id, 9);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;          $species_index = <span class="stringliteral">&quot;species-$num&quot;</span>;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        }</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        $id_col_accession_name = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-groups&#39;</span>][<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160; </div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($indel_fid, $tree_accession_file, $id_col_name, $id_col_accession_name, FALSE, $acc_no_header);</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160; </div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;          $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][indels&quot;</span>, <span class="stringliteral">&quot;Indel Genotype Spreadsheet: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your Genotype file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        }</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      }</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160; </div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        $file = file_load($indel_fid);</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_Indel_Assay_$org_num&quot;</span>;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;      }</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160; </div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keywordflow">if</span> (!empty($file_type[<span class="stringliteral">&#39;Other Marker Genotype Spreadsheet&#39;</span>]) and !$genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>]) {</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][genotype][files][other]&quot;</span>, <span class="stringliteral">&quot;Other Marker Spreadsheet: field is required.&quot;</span>);</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    }</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    elseif (!empty($file_type[<span class="stringliteral">&#39;Other Marker Genotype Spreadsheet&#39;</span>])) {</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;columns&#39;</span>, $form[$id][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>])) {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        $required_groups = array(</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;          <span class="stringliteral">&#39;Tree Id&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;            <span class="stringliteral">&#39;id&#39;</span> =&gt; array(1),</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;          ),</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;          <span class="stringliteral">&#39;Genotype Data&#39;</span> =&gt; array(</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            <span class="stringliteral">&#39;data&#39;</span> =&gt; array(0),</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;          ),</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        );</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        $file_element = $form[$id][<span class="stringliteral">&#39;genotype&#39;</span>][<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>];</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        $groups = <a class="code" href="file__utils_8inc.html#acedf90c1091e02904f2bd886b83640fe">tpps_file_validate_columns</a>($form_state, $required_groups, $file_element);</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="comment">// Get Plant Id column name.</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;          $id_col_genotype_name = $groups[<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        }</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      }</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        $headers = <a class="code" href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a>($genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>]);</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;          $id_col_genotype_name = key($headers);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        }</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;      }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160; </div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        $species_index = <span class="stringliteral">&quot;species-$org_num&quot;</span>;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][<span class="stringliteral">&#39;check&#39;</span>])) {</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;          $species_index = <span class="stringliteral">&quot;species-1&quot;</span>;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        }</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        $tree_accession_file = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file&#39;</span>];</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        $id_col_accession_name = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-groups&#39;</span>][<span class="stringliteral">&#39;Tree Id&#39;</span>][<span class="charliteral">&#39;1&#39;</span>];</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160; </div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        $acc_no_header = $form_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a>][<span class="stringliteral">&#39;tree-accession&#39;</span>][$species_index][<span class="stringliteral">&#39;file-no-header&#39;</span>];</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        $other_no_header = $genotype[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;other-no-header&#39;</span>] ?? FALSE;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        $missing_trees = <a class="code" href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a>($other_file, $tree_accession_file, $id_col_genotype_name, $id_col_accession_name, $other_no_header, $acc_no_header);</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160; </div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <span class="keywordflow">if</span> ($missing_trees !== array()) {</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;          $tree_id_str = implode(<span class="stringliteral">&#39;, &#39;</span>, $missing_trees);</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;          form_set_error(<span class="stringliteral">&quot;$id][genotype][files][other&quot;</span>, <span class="stringliteral">&quot;Other Marker Genotype Spreadsheet: We detected Plant Identifiers that were not in your Plant Accession file. Please either remove these plants from your Genotype file, or add them to your Plant Accesison file. The Plant Identifiers we found were: $tree_id_str&quot;</span>);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      }</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;      <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="comment">// Preserve file if it is valid.</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        $file = file_load($other_file);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        file_usage_add($file, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_project&#39;</span>, substr($form_state[<span class="stringliteral">&#39;accession&#39;</span>], 4));</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        $form_state[<span class="stringliteral">&#39;file_info&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][$file-&gt;fid] = <span class="stringliteral">&quot;Genotype_Other_Marker_Spreadsheet_$org_num&quot;</span>;</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;      }</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    }</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  }</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;}</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160; </div>
<div class="line"><a name="l00926"></a><span class="lineno"><a class="line" href="validate_2page__4_8php.html#aa3f1c80bca794610888f67daa0449540">  926</a></span>&#160;<span class="keyword">function</span> <a class="code" href="validate_2page__4_8php.html#aa3f1c80bca794610888f67daa0449540">tpps_validate_environment</a>(array &amp;$environment, $id) {</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <span class="comment">// Using cartograplant environment layers.</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  $group_check = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  $new_layers = array();</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordflow">foreach</span> ($environment[<span class="stringliteral">&#39;env_layers_groups&#39;</span>] as $group_name =&gt; $group_id) {</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordflow">if</span> (!empty($group_id)) {</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      $group_check .= <span class="stringliteral">&quot;1&quot;</span>;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;      <span class="keywordflow">if</span> ($group_name == <span class="stringliteral">&#39;WorldClim v.2 (WorldClim)&#39;</span>) {</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        $subgroups_query = db_select(<span class="stringliteral">&#39;cartogratree_layers&#39;</span>, <span class="charliteral">&#39;l&#39;</span>)</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;          -&gt;distinct()</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;          -&gt;fields(<span class="charliteral">&#39;l&#39;</span>, array(<span class="stringliteral">&#39;subgroup_id&#39;</span>))</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;          -&gt;condition(<span class="stringliteral">&#39;group_id&#39;</span>, $group_id)</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;          -&gt;execute();</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <span class="keywordflow">while</span> (($subgroup = $subgroups_query-&gt;fetchObject())) {</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;          $subgroup_title = db_select(<span class="stringliteral">&#39;cartogratree_subgroups&#39;</span>, <span class="charliteral">&#39;s&#39;</span>)</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;            -&gt;fields(<span class="charliteral">&#39;s&#39;</span>, array(<span class="stringliteral">&#39;subgroup_name&#39;</span>))</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            -&gt;condition(<span class="stringliteral">&#39;subgroup_id&#39;</span>, $subgroup-&gt;subgroup_id)</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            -&gt;execute()</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;            -&gt;fetchObject()-&gt;subgroup_name;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;          <span class="keywordflow">if</span> (!empty($environment[<span class="stringliteral">&#39;env_layers&#39;</span>][$subgroup_title])) {</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;            $new_layers[$subgroup_title] = $environment[<span class="stringliteral">&#39;env_layers&#39;</span>][$subgroup_title];</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;          }</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        }</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;      }</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        $layer_query = db_select(<span class="stringliteral">&#39;cartogratree_layers&#39;</span>, <span class="charliteral">&#39;l&#39;</span>)</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;          -&gt;fields(<span class="charliteral">&#39;l&#39;</span>, array(<span class="stringliteral">&#39;title&#39;</span>))</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;          -&gt;condition(<span class="stringliteral">&#39;group_id&#39;</span>, $group_id)</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;          -&gt;execute();</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="keywordflow">while</span> (($layer = $layer_query-&gt;fetchObject())) {</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;          <span class="keywordflow">if</span> (!empty($environment[<span class="stringliteral">&#39;env_layers&#39;</span>][$layer-&gt;title])) {</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;            $new_layers[$layer-&gt;title] = $environment[<span class="stringliteral">&#39;env_layers&#39;</span>][$layer-&gt;title];</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;          }</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        }</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;      }</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    }</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      $group_check .= <span class="stringliteral">&quot;0&quot;</span>;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    }</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  }</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160; </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="keywordflow">if</span> (!empty($environment[<span class="stringliteral">&#39;env_layers&#39;</span>][<span class="stringliteral">&#39;other&#39;</span>])) {</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <span class="keywordflow">if</span> (empty($environment[<span class="stringliteral">&#39;env_layers&#39;</span>][<span class="stringliteral">&#39;other_db&#39;</span>])) {</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][environment][env_layers][other_db&quot;</span>, <span class="stringliteral">&#39;CartograPlant other environmental layer DB: field is required.&#39;</span>);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    }</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160; </div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="keywordflow">if</span> (empty($environment[<span class="stringliteral">&#39;env_layers&#39;</span>][<span class="stringliteral">&#39;other_name&#39;</span>])) {</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;      form_set_error(<span class="stringliteral">&quot;$id][environment][env_layers][other_name&quot;</span>, <span class="stringliteral">&#39;CartograPlant other environmental layer name: field is required.&#39;</span>);</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    }</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160; </div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordflow">if</span> (!form_get_errors()) {</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;      $new_layers[<span class="stringliteral">&#39;other&#39;</span>] = <span class="stringliteral">&#39;other&#39;</span>;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;      $new_layers[<span class="stringliteral">&#39;other_db&#39;</span>] = $environment[<span class="stringliteral">&#39;env_layers&#39;</span>][<span class="stringliteral">&#39;other_db&#39;</span>];</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;      $new_layers[<span class="stringliteral">&#39;other_name&#39;</span>] = $environment[<span class="stringliteral">&#39;env_layers&#39;</span>][<span class="stringliteral">&#39;other_name&#39;</span>];</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    }</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  }</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160; </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  $environment[<span class="stringliteral">&#39;env_layers&#39;</span>] = $new_layers;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160; </div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^0+$/&#39;</span>, $group_check)) {</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][environment][env_layers_groups&quot;</span>, <span class="stringliteral">&#39;CartograPlant environmental layers groups: field is required.&#39;</span>);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  }</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  elseif (empty($new_layers)) {</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    form_set_error(<span class="stringliteral">&quot;$id][environment][env_layers&quot;</span>, <span class="stringliteral">&#39;CartograPlant environmental layers: field is required.&#39;</span>);</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  }</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="avalidate_2page__4_8php_html_a6d7de4f1dbe7b3c14bfb86231b8de7b2"><div class="ttname"><a href="validate_2page__4_8php.html#a6d7de4f1dbe7b3c14bfb86231b8de7b2">tpps_validate_phenotype</a></div><div class="ttdeci">tpps_validate_phenotype(array $phenotype, $org_num, array $form, array &amp;$form_state)</div><div class="ttdef"><b>Definition:</b> <a href="validate_2page__4_8php_source.html#l00105">page_4.php:105</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_a86f3c1f203f47ecd5baa381a14fd22b2"><div class="ttname"><a href="file__utils_8inc.html#a86f3c1f203f47ecd5baa381a14fd22b2">tpps_file_width</a></div><div class="ttdeci">tpps_file_width($fid)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00114">file_utils.inc:114</a></div></div>
<div class="ttc" id="avalidate_2page__4_8php_html_a9572a6c7fd517d3db39e822551142ef9"><div class="ttname"><a href="validate_2page__4_8php.html#a9572a6c7fd517d3db39e822551142ef9">tpps_page_4_validate_form</a></div><div class="ttdeci">tpps_page_4_validate_form(array &amp;$form, array &amp;$form_state)</div><div class="ttdef"><b>Definition:</b> <a href="validate_2page__4_8php_source.html#l00016">page_4.php:16</a></div></div>
<div class="ttc" id="atpps_8module_html_aee3f84bc39f996a79a7937348f3fd014"><div class="ttname"><a href="tpps_8module.html#aee3f84bc39f996a79a7937348f3fd014">TPPS_PAGE_3</a></div><div class="ttdeci">const TPPS_PAGE_3</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00014">tpps.module:14</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_a4ea01f157958a5f304919c60cf04e84d"><div class="ttname"><a href="file__utils_8inc.html#a4ea01f157958a5f304919c60cf04e84d">tpps_file_len</a></div><div class="ttdeci">tpps_file_len($fid)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00064">file_utils.inc:64</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_ab3aaa23338a57219a37369743bcdd1ab"><div class="ttname"><a href="file__utils_8inc.html#ab3aaa23338a57219a37369743bcdd1ab">tpps_file_headers</a></div><div class="ttdeci">tpps_file_headers($fid, $no_header=FALSE)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00821">file_utils.inc:821</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_a6176e642def9ba548e7b0a8c1fb01026"><div class="ttname"><a href="file__utils_8inc.html#a6176e642def9ba548e7b0a8c1fb01026">tpps_parse_file_column</a></div><div class="ttdeci">tpps_parse_file_column($fid, $column, $no_header=FALSE)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00310">file_utils.inc:310</a></div></div>
<div class="ttc" id="avalidate_2page__4_8php_html_ad613dde70484b7d5884470b3d7dded34"><div class="ttname"><a href="validate_2page__4_8php.html#ad613dde70484b7d5884470b3d7dded34">tpps_validate_genotype</a></div><div class="ttdeci">tpps_validate_genotype(array $genotype, $org_num, array $form, array &amp;$form_state)</div><div class="ttdef"><b>Definition:</b> <a href="validate_2page__4_8php_source.html#l00336">page_4.php:336</a></div></div>
<div class="ttc" id="avalidate_2page__4_8php_html_aa3f1c80bca794610888f67daa0449540"><div class="ttname"><a href="validate_2page__4_8php.html#aa3f1c80bca794610888f67daa0449540">tpps_validate_environment</a></div><div class="ttdeci">tpps_validate_environment(array &amp;$environment, $id)</div><div class="ttdef"><b>Definition:</b> <a href="validate_2page__4_8php_source.html#l00926">page_4.php:926</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_a02cb2be506d23ec7eb9324ef5b0a6ff4"><div class="ttname"><a href="file__utils_8inc.html#a02cb2be506d23ec7eb9324ef5b0a6ff4">tpps_compare_files</a></div><div class="ttdeci">tpps_compare_files($fid_1, $fid_2, $file_1_id_name, $file_2_id_name, $file_1_no_header=FALSE, $file_2_no_header=FALSE)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00355">file_utils.inc:355</a></div></div>
<div class="ttc" id="atpps_8module_html_afc7626d0d50cc6f3389e67ff010c6d23"><div class="ttname"><a href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a></div><div class="ttdeci">const TPPS_PAGE_1</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00012">tpps.module:12</a></div></div>
<div class="ttc" id="afile__utils_8inc_html_acedf90c1091e02904f2bd886b83640fe"><div class="ttname"><a href="file__utils_8inc.html#acedf90c1091e02904f2bd886b83640fe">tpps_file_validate_columns</a></div><div class="ttdeci">tpps_file_validate_columns(array &amp;$form_state, array $required_groups, array $file_element)</div><div class="ttdef"><b>Definition:</b> <a href="file__utils_8inc_source.html#l00418">file_utils.inc:418</a></div></div>
<div class="ttc" id="atpps_8module_html_a1a0b618b0cc8e20078ea6112770594f8"><div class="ttname"><a href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a></div><div class="ttdeci">const TPPS_PAGE_4</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00015">tpps.module:15</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_9dbe3317d04b259e5582aecba81cb3e5.html">forms</a></li><li class="navelem"><a class="el" href="dir_a73fdf4a4beb9dc5d3cc196e954a765a.html">validate</a></li><li class="navelem"><a class="el" href="validate_2page__4_8php.html">page_4.php</a></li>
    <li class="footer">Generated on Fri Aug 21 2020 13:58:19 for Tripal Plant PopGen Submit by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
