<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Tripal Plant PopGen Submit: /var/www/html/sites/all/modules/TGDR/admin/panel.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tripal Plant PopGen Submit
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('panel_8php_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">panel.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="panel_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="panel_8php.html#af6f959604ff2d59206819924181f68ed">   35</a></span>&#160;<span class="keyword">function</span> <a class="code" href="panel_8php.html#af6f959604ff2d59206819924181f68ed">tpps_admin_panel</a>(array $form, array &amp;$form_state, $accession = NULL) {</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  global $user;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  global $base_url;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keywordflow">if</span> (empty($accession)) {</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    $submissions = <a class="code" href="submissions_8inc.html#a67f98c19acc21d584dac24d49a085530">tpps_load_submission_multiple</a>(array(</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      <span class="stringliteral">&#39;status&#39;</span> =&gt; array(</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        <span class="stringliteral">&#39;Pending Approval&#39;</span>,</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="stringliteral">&#39;Submission Job Running&#39;</span>,</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        <span class="stringliteral">&#39;Approved&#39;</span>,</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        <span class="stringliteral">&#39;Approved - Delayed Submission Release&#39;</span>,</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;      ),</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    ), FALSE);</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    $pending = array();</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    $approved = array();</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    $contact_bundle = tripal_load_bundle_entity(array(<span class="stringliteral">&#39;label&#39;</span> =&gt; <span class="stringliteral">&#39;Tripal Contact Profile&#39;</span>));</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">foreach</span> ($submissions as $submission) {</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;      $state = unserialize($submission-&gt;submission_state);</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      $mail = user_load($submission-&gt;uid)-&gt;mail;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      <span class="keywordflow">if</span> ($contact_bundle) {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        $query = <span class="keyword">new</span> EntityFieldQuery();</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        $results = $query-&gt;entityCondition(<span class="stringliteral">&#39;entity_type&#39;</span>, <span class="stringliteral">&#39;TripalEntity&#39;</span>)</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;          -&gt;entityCondition(<span class="stringliteral">&#39;bundle&#39;</span>, $contact_bundle-&gt;name)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;          -&gt;fieldCondition(<span class="stringliteral">&#39;local__email&#39;</span>, <span class="stringliteral">&#39;value&#39;</span>, $mail)</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;          -&gt;range(0, 1)</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;          -&gt;execute();</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordflow">if</span> (!empty($results[<span class="stringliteral">&#39;TripalEntity&#39;</span>])) {</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;          $id = current($results[<span class="stringliteral">&#39;TripalEntity&#39;</span>])-&gt;id;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;          $entity = current(tripal_load_entity(<span class="stringliteral">&#39;TripalEntity&#39;</span>, array($id))) ?? NULL;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        }</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      }</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;      <span class="keywordflow">if</span> (!empty($state)) {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        $row = array(</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;          l($state[<span class="stringliteral">&#39;accession&#39;</span>], <span class="stringliteral">&quot;$base_url/tpps-admin-panel/{$state[&#39;accession&#39;]}&quot;</span>),</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;          $entity-&gt;title ?? NULL,</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;          $state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a>][<span class="stringliteral">&#39;publication&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>],</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;          $state[<span class="stringliteral">&#39;status&#39;</span>],</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        );</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">if</span> ($state[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;Pending Approval&#39;</span>) {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;          $pending[(int) substr($state[<span class="stringliteral">&#39;accession&#39;</span>], 4)] = $row;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        }</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;          $approved[(int) substr($state[<span class="stringliteral">&#39;accession&#39;</span>], 4)] = $row;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        }</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      }</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    }</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    ksort($pending);</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    ksort($approved);</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    $rows = array_merge($pending, $approved);</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    $headers = array(</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      <span class="stringliteral">&#39;Accession Number&#39;</span>,</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      <span class="stringliteral">&#39;Submitting User&#39;</span>,</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;      <span class="stringliteral">&#39;Title&#39;</span>,</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;      <span class="stringliteral">&#39;Status&#39;</span>,</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    );</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    $vars = array(</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;      <span class="stringliteral">&#39;header&#39;</span> =&gt; $headers,</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;      <span class="stringliteral">&#39;rows&#39;</span> =&gt; $rows,</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array(</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;view&#39;</span>, <span class="stringliteral">&#39;tpps_table&#39;</span>),</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="stringliteral">&#39;id&#39;</span> =&gt; <span class="stringliteral">&#39;tpps_table_display&#39;</span>,</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;      ),</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      <span class="stringliteral">&#39;caption&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="stringliteral">&#39;colgroups&#39;</span> =&gt; NULL,</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      <span class="stringliteral">&#39;sticky&#39;</span> =&gt; FALSE,</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    );</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    $form[<span class="stringliteral">&#39;#attributes&#39;</span>] = array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;hide-me&#39;</span>));</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    $form[<span class="stringliteral">&#39;#suffix&#39;</span>] = <span class="stringliteral">&quot;&lt;div class=&#39;tpps_table&#39;&gt;&lt;label for=&#39;tpps_table_display&#39;&gt;Completed TPPS Submissions&lt;/label&gt;&quot;</span> . theme_table($vars) . <span class="stringliteral">&quot;&lt;/div&gt;&quot;</span>;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    $tpps_new_orgs = variable_get(<span class="stringliteral">&#39;tpps_new_organisms&#39;</span>, NULL);</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    $db = chado_get_db(array(<span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;NCBI Taxonomy&#39;</span>));</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordflow">if</span> (!empty($db)) {</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      $rows = array();</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      $query = db_select(<span class="stringliteral">&#39;chado.organism&#39;</span>, <span class="charliteral">&#39;o&#39;</span>);</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      $query-&gt;fields(<span class="charliteral">&#39;o&#39;</span>, array(<span class="stringliteral">&#39;genus&#39;</span>, <span class="stringliteral">&#39;species&#39;</span>));</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      $query_e = db_select(<span class="stringliteral">&#39;chado.organism_dbxref&#39;</span>, <span class="stringliteral">&#39;odb&#39;</span>);</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      $query_e-&gt;join(<span class="stringliteral">&#39;chado.dbxref&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="stringliteral">&#39;d.dbxref_id = odb.dbxref_id&#39;</span>);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      $query_e-&gt;condition(<span class="stringliteral">&#39;d.db_id&#39;</span>, $db-&gt;db_id)</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        -&gt;where(<span class="stringliteral">&#39;odb.organism_id = o.organism_id&#39;</span>);</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      $query-&gt;notExists($query_e);</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;      $query = $query-&gt;execute();</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      <span class="keywordflow">while</span> (($org = $query-&gt;fetchObject())) {</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        $rows[] = array(</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;          <span class="stringliteral">&quot;$org-&gt;genus $org-&gt;species&quot;</span>,</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        );</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      }</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <span class="keywordflow">if</span> (!empty($rows)) {</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        $headers = array();</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        $vars = array(</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;          <span class="stringliteral">&#39;header&#39;</span> =&gt; $headers,</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;          <span class="stringliteral">&#39;rows&#39;</span> =&gt; $rows,</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;          <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array(</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;view&#39;</span>, <span class="stringliteral">&#39;tpps_table&#39;</span>),</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            <span class="stringliteral">&#39;id&#39;</span> =&gt; <span class="stringliteral">&#39;new_species&#39;</span>,</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;          ),</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;          <span class="stringliteral">&#39;caption&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;          <span class="stringliteral">&#39;colgroups&#39;</span> =&gt; NULL,</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;          <span class="stringliteral">&#39;sticky&#39;</span> =&gt; FALSE,</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;          <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        );</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        $form[<span class="stringliteral">&#39;#suffix&#39;</span>] .= <span class="stringliteral">&quot;&lt;div class=&#39;tpps_table&#39;&gt;&lt;label for=&#39;new_species&#39;&gt;New Species: the species listed below likely need to be updated, because they do not have NCBI Taxonomy identifiers in the database.&lt;/label&gt;&quot;</span> . theme_table($vars) . <span class="stringliteral">&quot;&lt;/div&gt;&quot;</span>;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      }</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      variable_set(<span class="stringliteral">&#39;tpps_new_organisms&#39;</span>, $tpps_new_orgs);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  }</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordflow">else</span> {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    $submission = <a class="code" href="submissions_8inc.html#a2f0513fcded43c8672e73ffedbc81dc4">tpps_load_submission</a>($accession, False);</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    $status = $submission-&gt;status;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    $submission_state = unserialize($submission-&gt;submission_state);</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    $submission_state[<span class="stringliteral">&#39;status&#39;</span>] = $status;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($submission_state);</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    $display = l(t(<span class="stringliteral">&quot;Back to TPPS Admin Panel&quot;</span>), <span class="stringliteral">&quot;$base_url/tpps-admin-panel&quot;</span>);</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    $display .= <a class="code" href="display_8inc.html#a27f41bdb5dced509e89cdeaf0912a60b">tpps_table_display</a>($submission_state);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    $form[<span class="stringliteral">&#39;form_table&#39;</span>] = array(</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;      <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;hidden&#39;</span>,</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      <span class="stringliteral">&#39;#value&#39;</span> =&gt; $accession,</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      <span class="stringliteral">&#39;#suffix&#39;</span> =&gt; $display,</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    );</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">if</span> ($status == <span class="stringliteral">&quot;Pending Approval&quot;</span>) {</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      $form[<span class="stringliteral">&#39;params&#39;</span>] = array(</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;fieldset&#39;</span>,</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="stringliteral">&#39;#title&#39;</span> =&gt; <span class="stringliteral">&#39;Select Environmental parameter types:&#39;</span>,</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="stringliteral">&#39;#tree&#39;</span> =&gt; TRUE,</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="stringliteral">&#39;#description&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      );</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      $orgamism_num = $submission_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a>][<span class="stringliteral">&#39;organism&#39;</span>][<span class="stringliteral">&#39;number&#39;</span>];</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      $show_layers = FALSE;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      <span class="keywordflow">for</span> ($i = 1; $i &lt;= $orgamism_num; $i++) {</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">if</span> (!empty($submission_state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a>][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>][<span class="stringliteral">&#39;use_layers&#39;</span>])) {</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;          <span class="keywordflow">foreach</span> ($submission_state[<span class="stringliteral">&#39;saved_values&#39;</span>][TPPS_PAGE_4][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>][<span class="stringliteral">&#39;env_layers&#39;</span>] as $layer =&gt; $layer_id) {</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">if</span> (!empty($layer_id)) {</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;              <span class="keywordflow">foreach</span> ($submission_state[<span class="stringliteral">&#39;saved_values&#39;</span>][TPPS_PAGE_4][<span class="stringliteral">&quot;organism-$i&quot;</span>][<span class="stringliteral">&#39;environment&#39;</span>][<span class="stringliteral">&#39;env_params&#39;</span>][$layer] as $param_name =&gt; $param_id) {</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="keywordflow">if</span> (!empty($param_id)) {</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                  $type = variable_get(<span class="stringliteral">&quot;tpps_param_{$param_id}_type&quot;</span>, NULL);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                  <span class="keywordflow">if</span> (empty($type)) {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                    $query = db_select(<span class="stringliteral">&#39;cartogratree_fields&#39;</span>, <span class="charliteral">&#39;f&#39;</span>)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                      -&gt;fields(<span class="charliteral">&#39;f&#39;</span>, array(<span class="stringliteral">&#39;display_name&#39;</span>))</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                      -&gt;condition(<span class="stringliteral">&#39;field_id&#39;</span>, $param_id)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                      -&gt;execute();</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                    $result = $query-&gt;fetchObject();</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                    $name = $result-&gt;display_name;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                    $form[<span class="stringliteral">&#39;params&#39;</span>][$param_id] = array(</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                      <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;radios&#39;</span>,</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                      <span class="stringliteral">&#39;#title&#39;</span> =&gt; <span class="stringliteral">&quot;Select Type for environmental layer parameter \&quot;$name\&quot;:&quot;</span>,</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                      <span class="stringliteral">&#39;#options&#39;</span> =&gt; array(</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                        <span class="stringliteral">&#39;attr_id&#39;</span> =&gt; <span class="stringliteral">&#39;attr_id&#39;</span>,</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                        <span class="stringliteral">&#39;cvterm&#39;</span> =&gt; <span class="stringliteral">&#39;cvterm&#39;</span>,</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                      ),</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                      <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                    );</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                    $show_layers = TRUE;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                  }</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                }</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;              }</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            }</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;          }</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        }</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      }</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="keywordflow">if</span> (!$show_layers) {</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        unset($form[<span class="stringliteral">&#39;params&#39;</span>]);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      }</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      $form[<span class="stringliteral">&#39;approve-check&#39;</span>] = array(</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;checkbox&#39;</span>,</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="stringliteral">&#39;#title&#39;</span> =&gt; t(<span class="stringliteral">&#39;This submission has been reviewed and approved.&#39;</span>),</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      );</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      $form[<span class="stringliteral">&#39;reject-reason&#39;</span>] = array(</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;textarea&#39;</span>,</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="stringliteral">&#39;#title&#39;</span> =&gt; t(<span class="stringliteral">&#39;Reason for rejection:&#39;</span>),</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="stringliteral">&#39;#states&#39;</span> =&gt; array(</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;          <span class="stringliteral">&#39;invisible&#39;</span> =&gt; array(</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="stringliteral">&#39;:input[name=&quot;approve-check&quot;]&#39;</span> =&gt; array(<span class="stringliteral">&#39;checked&#39;</span> =&gt; TRUE),</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;          ),</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        ),</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      );</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      $form[<span class="stringliteral">&#39;REJECT&#39;</span>] = array(</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="stringliteral">&#39;#value&#39;</span> =&gt; t(<span class="stringliteral">&#39;Reject&#39;</span>),</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="stringliteral">&#39;#states&#39;</span> =&gt; array(</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;          <span class="stringliteral">&#39;invisible&#39;</span> =&gt; array(</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="stringliteral">&#39;:input[name=&quot;approve-check&quot;]&#39;</span> =&gt; array(<span class="stringliteral">&#39;checked&#39;</span> =&gt; TRUE),</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;          ),</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        ),</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;      );</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      $form[<span class="stringliteral">&#39;APPROVE&#39;</span>] = array(</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="stringliteral">&#39;#value&#39;</span> =&gt; t(<span class="stringliteral">&#39;Approve&#39;</span>),</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="stringliteral">&#39;#states&#39;</span> =&gt; array(</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;          <span class="stringliteral">&#39;visible&#39;</span> =&gt; array(</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            <span class="stringliteral">&#39;:input[name=&quot;approve-check&quot;]&#39;</span> =&gt; array(<span class="stringliteral">&#39;checked&#39;</span> =&gt; TRUE),</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          ),</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        ),</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;      );</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    }</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    $form[<span class="stringliteral">&#39;state-status&#39;</span>] = array(</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;select&#39;</span>,</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;      <span class="stringliteral">&#39;#title&#39;</span> =&gt; t(<span class="stringliteral">&#39;Change state status&#39;</span>),</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      <span class="stringliteral">&#39;#description&#39;</span> =&gt; t(<span class="stringliteral">&#39;Warning: This feature is experimental and may cause unforseen issues. Please do not change the status of this submission unless you are willing to risk the loss of existing data. The current status of the submission is @status.&#39;</span>, array(<span class="stringliteral">&#39;@status&#39;</span> =&gt; $status)),</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;      <span class="stringliteral">&#39;#options&#39;</span> =&gt; array(</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="stringliteral">&#39;Incomplete&#39;</span> =&gt; <span class="stringliteral">&#39;Incomplete&#39;</span>,</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="stringliteral">&#39;Pending Approval&#39;</span> =&gt; <span class="stringliteral">&#39;Pending Approval&#39;</span>,</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="stringliteral">&#39;Submission Job Running&#39;</span> =&gt; <span class="stringliteral">&#39;Submission Job Running&#39;</span>,</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="stringliteral">&#39;Approved&#39;</span> =&gt; <span class="stringliteral">&#39;Approved&#39;</span>,</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="stringliteral">&#39;Approved - Delayed Submission Release&#39;</span> =&gt; <span class="stringliteral">&#39;Approved - Delayed Submission Release&#39;</span>,</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      ),</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;      <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; $status,</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    );</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    $form[<span class="stringliteral">&#39;CHANGE_STATUS&#39;</span>] = array(</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      <span class="stringliteral">&#39;#value&#39;</span> =&gt; t(<span class="stringliteral">&#39;Change Status&#39;</span>),</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      <span class="stringliteral">&#39;#states&#39;</span> =&gt; array(</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="stringliteral">&#39;invisible&#39;</span> =&gt; array(</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;          <span class="stringliteral">&#39;:input[name=&quot;state-status&quot;]&#39;</span> =&gt; array(<span class="stringliteral">&#39;value&#39;</span> =&gt; $status),</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        ),</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      ),</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    );</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  }</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  drupal_add_js(drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;tpps&#39;</span>) . <a class="code" href="tpps_8module.html#a59150ed46f481f0766cb1b292a65fef3">TPPS_JS_PATH</a>);</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  drupal_add_css(drupal_get_path(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;tpps&#39;</span>) . <a class="code" href="tpps_8module.html#a84e634ae18cb7746f61bd28bbcd45108">TPPS_CSS_PATH</a>);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="keywordflow">return</span> $form;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;}</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00288"></a><span class="lineno"><a class="line" href="panel_8php.html#abe11b2f629616b0c6570c13f6ac214cd">  288</a></span>&#160;<span class="keyword">function</span> <a class="code" href="panel_8php.html#abe11b2f629616b0c6570c13f6ac214cd">tpps_admin_panel_validate</a>($form, &amp;$form_state) {</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;submitted&#39;</span>] == <span class="charliteral">&#39;1&#39;</span>) {</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;reject-reason&#39;</span>]) and $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;reject-reason&#39;</span>] == <span class="stringliteral">&#39;&#39;</span> and $form_state[<span class="stringliteral">&#39;triggering_element&#39;</span>][<span class="stringliteral">&#39;#value&#39;</span>] == <span class="stringliteral">&#39;Reject&#39;</span>) {</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      form_set_error(<span class="stringliteral">&#39;reject-reason&#39;</span>, <span class="stringliteral">&#39;Please explain why the submission was rejected.&#39;</span>);</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    }</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  }</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;}</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno"><a class="line" href="panel_8php.html#a4dbd72c685e852f0fe1f8d71ccc8f375">  303</a></span>&#160;<span class="keyword">function</span> <a class="code" href="panel_8php.html#a4dbd72c685e852f0fe1f8d71ccc8f375">tpps_admin_panel_submit</a>($form, &amp;$form_state) {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  global $base_url;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  $type = $form_state[<span class="stringliteral">&#39;tpps_type&#39;</span>] ?? <span class="stringliteral">&#39;tpps&#39;</span>;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  $type_label = ($type == <span class="stringliteral">&#39;tpps&#39;</span>) ? <span class="stringliteral">&#39;TPPS&#39;</span> : <span class="stringliteral">&#39;TPPSC&#39;</span>;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  $accession = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;form_table&#39;</span>];</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  $submission = <a class="code" href="submissions_8inc.html#a2f0513fcded43c8672e73ffedbc81dc4">tpps_load_submission</a>($accession, FALSE);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  $user = user_load($submission-&gt;uid);</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  $to = $user-&gt;mail;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  $state = unserialize($submission-&gt;submission_state);</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  $params = array();</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  $from = variable_get(<span class="stringliteral">&#39;site_mail&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  $params[<span class="stringliteral">&#39;subject&#39;</span>] = <span class="stringliteral">&quot;$type_label Submission Rejected: {$state[&#39;saved_values&#39;][TPPS_PAGE_1][&#39;publication&#39;][&#39;title&#39;]}&quot;</span>;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  $params[<span class="stringliteral">&#39;uid&#39;</span>] = $user-&gt;uid;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  $params[<span class="stringliteral">&#39;reject-reason&#39;</span>] = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;reject-reason&#39;</span>] ?? NULL;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  $params[<span class="stringliteral">&#39;base_url&#39;</span>] = $base_url;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  $params[<span class="stringliteral">&#39;title&#39;</span>] = $state[<span class="stringliteral">&#39;saved_values&#39;</span>][<a class="code" href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a>][<span class="stringliteral">&#39;publication&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>];</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  $params[<span class="stringliteral">&#39;body&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  $params[<span class="stringliteral">&#39;headers&#39;</span>][] = <span class="stringliteral">&#39;MIME-Version: 1.0&#39;</span>;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  $params[<span class="stringliteral">&#39;headers&#39;</span>][] = <span class="stringliteral">&#39;Content-type: text/html; charset=iso-8859-1&#39;</span>;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;params&#39;</span>])) {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">foreach</span> ($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;params&#39;</span>] as $param_id =&gt; $type) {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      variable_set(<span class="stringliteral">&quot;tpps_param_{$param_id}_type&quot;</span>, $type);</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  }</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;triggering_element&#39;</span>][<span class="stringliteral">&#39;#value&#39;</span>] == <span class="stringliteral">&#39;Reject&#39;</span>) {</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    drupal_mail($type, <span class="stringliteral">&#39;user_rejected&#39;</span>, $to, user_preferred_language($user), $params, $from, TRUE);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    unset($state[<span class="stringliteral">&#39;status&#39;</span>]);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($state, array(<span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="stringliteral">&#39;Incomplete&#39;</span>));</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    drupal_set_message(t(<span class="stringliteral">&#39;Submission Rejected. Message has been sent to user.&#39;</span>), <span class="stringliteral">&#39;status&#39;</span>);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    drupal_goto(<span class="stringliteral">&#39;&lt;front&gt;&#39;</span>);</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  }</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  elseif ($form_state[<span class="stringliteral">&#39;triggering_element&#39;</span>][<span class="stringliteral">&#39;#value&#39;</span>] == <span class="stringliteral">&#39;Approve&#39;</span>) {</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    module_load_include(<span class="stringliteral">&#39;php&#39;</span>, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;forms/submit/submit_all&#39;</span>);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    global $user;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    $uid = $user-&gt;uid;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    $state[<span class="stringliteral">&#39;submitting_uid&#39;</span>] = $uid;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    $params[<span class="stringliteral">&#39;subject&#39;</span>] = <span class="stringliteral">&quot;$type_label Submission Approved: {$state[&#39;saved_values&#39;][TPPS_PAGE_1][&#39;publication&#39;][&#39;title&#39;]}&quot;</span>;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    $params[<span class="stringliteral">&#39;accession&#39;</span>] = $state[<span class="stringliteral">&#39;accession&#39;</span>];</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    drupal_set_message(t(<span class="stringliteral">&#39;Submission Approved! Message has been sent to user.&#39;</span>), <span class="stringliteral">&#39;status&#39;</span>);</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    drupal_mail($type, <span class="stringliteral">&#39;user_approved&#39;</span>, $to, user_preferred_language(user_load_by_name($to)), $params, $from, TRUE);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    $includes = array();</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    $includes[] = module_load_include(<span class="stringliteral">&#39;php&#39;</span>, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;forms/submit/submit_all&#39;</span>);</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    $includes[] = module_load_include(<span class="stringliteral">&#39;inc&#39;</span>, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;includes/file_parsing&#39;</span>);</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    $args = array($accession);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">if</span> ($state[<span class="stringliteral">&#39;saved_values&#39;</span>][<span class="stringliteral">&#39;summarypage&#39;</span>][<span class="stringliteral">&#39;release&#39;</span>]) {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      $jid = tripal_add_job(<span class="stringliteral">&quot;$type_label Record Submission - $accession&quot;</span>, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_submit_all&#39;</span>, $args, $state[<span class="stringliteral">&#39;submitting_uid&#39;</span>], 10, $includes, TRUE);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      $state[<span class="stringliteral">&#39;job_id&#39;</span>] = $jid;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($state);</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    }</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      $date = $state[<span class="stringliteral">&#39;saved_values&#39;</span>][<span class="stringliteral">&#39;summarypage&#39;</span>][<span class="stringliteral">&#39;release-date&#39;</span>];</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      $time = strtotime(<span class="stringliteral">&quot;{$date[&#39;year&#39;]}-{$date[&#39;month&#39;]}-{$date[&#39;day&#39;]}&quot;</span>);</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;      <span class="keywordflow">if</span> (time() &gt; $time) {</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        $jid = tripal_add_job(<span class="stringliteral">&quot;$type_label Record Submission - $accession&quot;</span>, <span class="stringliteral">&#39;tpps&#39;</span>, <span class="stringliteral">&#39;tpps_submit_all&#39;</span>, $args, $state[<span class="stringliteral">&#39;submitting_uid&#39;</span>], 10, $includes, TRUE);</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        $state[<span class="stringliteral">&#39;job_id&#39;</span>] = $jid;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($state);</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;      }</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      <span class="keywordflow">else</span> {</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        $delayed_submissions = variable_get(<span class="stringliteral">&#39;tpps_delayed_submissions&#39;</span>, array());</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        $delayed_submissions[$accession] = $accession;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        variable_set(<span class="stringliteral">&#39;tpps_delayed_submissions&#39;</span>, $delayed_submissions);</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        $state[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;Approved - Delayed Submission Release&#39;</span>;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($state);</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      }</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    }</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  }</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordflow">else</span> {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    $state[<span class="stringliteral">&#39;status&#39;</span>] = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;state-status&#39;</span>];</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <a class="code" href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a>($state);</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  }</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div><div class="ttc" id="tpps_8module_html_afc7626d0d50cc6f3389e67ff010c6d23"><div class="ttname"><a href="tpps_8module.html#afc7626d0d50cc6f3389e67ff010c6d23">TPPS_PAGE_1</a></div><div class="ttdeci">const TPPS_PAGE_1</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00010">tpps.module:10</a></div></div>
<div class="ttc" id="panel_8php_html_a4dbd72c685e852f0fe1f8d71ccc8f375"><div class="ttname"><a href="panel_8php.html#a4dbd72c685e852f0fe1f8d71ccc8f375">tpps_admin_panel_submit</a></div><div class="ttdeci">tpps_admin_panel_submit($form, &amp;$form_state)</div><div class="ttdef"><b>Definition:</b> <a href="panel_8php_source.html#l00303">panel.php:303</a></div></div>
<div class="ttc" id="submissions_8inc_html_a3ebff14eec8c6c0220fe809e07679eeb"><div class="ttname"><a href="submissions_8inc.html#a3ebff14eec8c6c0220fe809e07679eeb">tpps_update_submission</a></div><div class="ttdeci">tpps_update_submission(array $state, array $options=array())</div><div class="ttdef"><b>Definition:</b> <a href="submissions_8inc_source.html#l00130">submissions.inc:130</a></div></div>
<div class="ttc" id="tpps_8module_html_a84e634ae18cb7746f61bd28bbcd45108"><div class="ttname"><a href="tpps_8module.html#a84e634ae18cb7746f61bd28bbcd45108">TPPS_CSS_PATH</a></div><div class="ttdeci">const TPPS_CSS_PATH</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00009">tpps.module:9</a></div></div>
<div class="ttc" id="tpps_8module_html_a59150ed46f481f0766cb1b292a65fef3"><div class="ttname"><a href="tpps_8module.html#a59150ed46f481f0766cb1b292a65fef3">TPPS_JS_PATH</a></div><div class="ttdeci">const TPPS_JS_PATH</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00008">tpps.module:8</a></div></div>
<div class="ttc" id="panel_8php_html_abe11b2f629616b0c6570c13f6ac214cd"><div class="ttname"><a href="panel_8php.html#abe11b2f629616b0c6570c13f6ac214cd">tpps_admin_panel_validate</a></div><div class="ttdeci">tpps_admin_panel_validate($form, &amp;$form_state)</div><div class="ttdef"><b>Definition:</b> <a href="panel_8php_source.html#l00288">panel.php:288</a></div></div>
<div class="ttc" id="submissions_8inc_html_a2f0513fcded43c8672e73ffedbc81dc4"><div class="ttname"><a href="submissions_8inc.html#a2f0513fcded43c8672e73ffedbc81dc4">tpps_load_submission</a></div><div class="ttdeci">tpps_load_submission($accession, $state=TRUE)</div><div class="ttdef"><b>Definition:</b> <a href="submissions_8inc_source.html#l00027">submissions.inc:27</a></div></div>
<div class="ttc" id="tpps_8module_html_a1a0b618b0cc8e20078ea6112770594f8"><div class="ttname"><a href="tpps_8module.html#a1a0b618b0cc8e20078ea6112770594f8">TPPS_PAGE_4</a></div><div class="ttdeci">const TPPS_PAGE_4</div><div class="ttdef"><b>Definition:</b> <a href="tpps_8module_source.html#l00013">tpps.module:13</a></div></div>
<div class="ttc" id="submissions_8inc_html_a67f98c19acc21d584dac24d49a085530"><div class="ttname"><a href="submissions_8inc.html#a67f98c19acc21d584dac24d49a085530">tpps_load_submission_multiple</a></div><div class="ttdeci">tpps_load_submission_multiple(array $conditions=array(), $state=TRUE)</div><div class="ttdef"><b>Definition:</b> <a href="submissions_8inc_source.html#l00068">submissions.inc:68</a></div></div>
<div class="ttc" id="display_8inc_html_a27f41bdb5dced509e89cdeaf0912a60b"><div class="ttname"><a href="display_8inc.html#a27f41bdb5dced509e89cdeaf0912a60b">tpps_table_display</a></div><div class="ttdeci">tpps_table_display(array &amp;$state)</div><div class="ttdef"><b>Definition:</b> <a href="display_8inc_source.html#l00542">display.inc:542</a></div></div>
<div class="ttc" id="panel_8php_html_af6f959604ff2d59206819924181f68ed"><div class="ttname"><a href="panel_8php.html#af6f959604ff2d59206819924181f68ed">tpps_admin_panel</a></div><div class="ttdeci">tpps_admin_panel(array $form, array &amp;$form_state, $accession=NULL)</div><div class="ttdef"><b>Definition:</b> <a href="panel_8php_source.html#l00035">panel.php:35</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b56013ff87e0b8a9fb902ef4a07a6990.html">admin</a></li><li class="navelem"><a class="el" href="panel_8php.html">panel.php</a></li>
    <li class="footer">Generated on Thu Feb 6 2020 13:48:44 for Tripal Plant PopGen Submit by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
