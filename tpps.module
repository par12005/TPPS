<?php

/**
 * @file
 * Core of the TPPS module.
 */

define("TPPS_MAJOR_VERSION", 1);
define("TPPS_MINOR_VERSION", 2);
define('TPPS_JS_PATH', '/js/tpps.js');
define('TPPS_CSS_PATH', '/css/tpps.css');
define('TPPS_PAGE_1', 1);
define('TPPS_PAGE_2', 2);
define('TPPS_PAGE_3', 3);
define('TPPS_PAGE_4', 4);
define('RESET_CACHE', TRUE);

define("TPPS_TEMP_XLSX", "temporary://tpps_xlsx");
define("TPPS_TEMP_ZIP", "temporary://tpps_zip");
define("TPPS_OLS_BASE", "http://www.ebi.ac.uk/ols/api/");
// Custom cache bin is used to allow to clear only modules cached data
// instead of whole cache clearing which could cause longer server
// response while cache is warming up.
define('TPPS_CACHE_BIN', 'cache_tpps');
// To avoid duplication we just get this path at the very beginning.
define('TPPS_MODULE_PATH', drupal_get_path('module', 'tpps'));
define('TPPS_IMAGES_PATH', TPPS_MODULE_PATH . '/images/');
define('TPPS_AJAX_URL', 'ajax/tpps');

// Page3. Accession file columns.
define('TPPS_COLUMN_PLANT_IDENTIFIER', 1);
define('TPPS_COLUMN_COUNTRY', 2);
define('TPPS_COLUMN_STATE', 3);
define('TPPS_COLUMN_LATITUDE', 4);
define('TPPS_COLUMN_LONGITUDE', 5);
define('TPPS_COLUMN_GENUS', 6);
define('TPPS_COLUMN_SPECIES', 7);
define('TPPS_COLUMN_COUNTY', 8);
define('TPPS_COLUMN_DISTRICT', 9);
define('TPPS_COLUMN_GENUS_AND_SPECIES', 10);
define('TPPS_COLUMN_SOURCE_PLANT_IDENTIFIER', 11);
define('TPPS_COLUMN_POPULATION_GROUP', 12);
define('TPPS_COLUMN_CLONE_NUMBER', 13);


require_once 'includes/common.inc';
module_load_include('inc', 'tpps', 'includes/common');
// Must be called after common.inc was loaded.
// Always enabled on dev-server and could be enabled on live-site.
if (!is_live_site() || variable_get('tpps_debug_mode', FALSE)) {
  ini_set('display_errors', 1);
  ini_set('display_startup_errors', 1);
  error_reporting(E_ALL);
}
require_once 'includes/display.inc';
require_once 'includes/chado_utils.inc';
require_once 'includes/init_project.inc';
require_once 'includes/standard_coord.inc';
require_once 'includes/cron.inc';
require_once 'includes/file_utils.inc';
require_once 'includes/submit_email.inc';
require_once 'includes/accession_coordinates.inc';
require_once 'includes/submissions.inc';
require_once 'includes/zenodo.inc';
require_once 'includes/match_trees.inc';
require_once 'includes/ncbi_utils.inc';
// All steps helper functions.
require_once 'includes/form.inc';
require_once 'includes/form_utils.inc';
require_once 'includes/details.inc';
require_once 'includes/cvterm_utils.inc';
// [VS]
require_once 'includes/submission_file.inc';
require_once 'includes/phenotype_synonym.inc';
require_once 'includes/phenotype_unit.inc';
require_once 'includes/easy_report.inc';
// [/VS]
require_once 'api/tpps.api.inc';
require_once 'includes/easy_report.inc';

/**
 * Implements hook_menu().
 */
function tpps_menu() {
  // TPPSc
  $items['tppsc'] = [
    'title' => 'Internal TPPS pipeline',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tppsc_main'],
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps form'],
    'type' => MENU_NORMAL_ITEM,
  ];

  $items['tppsc/%'] = [
    'title' => 'Internal TPPS pipeline',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tppsc_main', 1],
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps form', 1],
    'type' => MENU_NORMAL_ITEM,
  ];

  $items['admin/config/content/tppsc'] = [
    'title' => 'TPPSC Settings',
    'description' => 'Configuration for TPPSC module',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_admin_settings'],
    'access arguments' => ['access administration pages'],
    'type' => MENU_NORMAL_ITEM,
    'file path' => drupal_get_path('module', 'tpps'),
    'file' => 'admin/config.php',
  ];
  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  // TPPS
  $items['tpps'] = array(
    'title' => 'Tripal Plant PopGen Submit',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_main'),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['tpps/%'] = array(
    'title' => 'Tripal Plant PopGen Submit',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_main', 1),
    'access callback' => 'tpps_access',
    'access arguments' => array('access tpps form', 1),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['tpps/%/pre-validate'] = array(
    'title' => 'TPPS File Pre-Validation',
    'page callback' => 'tpps_pre_validate_init',
    'page arguments' => array(1),
    'access callback' => 'tpps_access',
    'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  $items['tpps/%/pre-validate/%/status'] = array(
    'title' => 'TPPS File Pre-Validation',
    'page callback' => 'tpps_pre_validate_status',
    'page arguments' => array(1, 3),
    'access callback' => 'tpps_access',
    'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );


  // This will return information about a study's Accession tree ids vs VCF tree ids
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/compare-accession-file-vs-vcf-file-tree-ids'] = array(
    'title' => 'TPPS Accession VCF Tree Ids',
    'page callback' => 'tpps_compare_accession_file_vs_vcf_file_tree_ids',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  // This will return information about a study's Accession tree ids
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/accession-file-tree-ids'] = [
    'title' => 'TPPS Accession Tree Ids',
    'page callback' => 'tpps_accession_file_tree_ids',
    'page arguments' => [1],
    'access arguments' => ['access content'],
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  ];


  // This will return information about a study's VCF tree ids
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/vcf-tree-ids'] = array(
    'title' => 'TPPS VCF Tree Ids',
    'page callback' => 'tpps_vcf_tree_ids',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  // This will return information about a study's VCF markers
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/vcf-markers'] = array(
    'title' => 'TPPS VCF Markers',
    'page callback' => 'tpps_vcf_markers',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  // This will return information about a study's VCF markers
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/snps-assay-markers'] = array(
    'title' => 'TPPS SNPs Assay Markers',
    'page callback' => 'tpps_snps_assay_markers',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  $items['tpps/%/assay-design-markers'] = array(
    'title' => 'TPPS SNPs Design Markers',
    'page callback' => 'tpps_assay_design_markers',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  // This will return information about a study's VCF markers vs
  // First % = accession
  // Second % = organism_index (1 or 2 or 3 etc) @TODO
  $items['tpps/%/compare-vcf-markers-vs-snps-assay-markers'] = array(
    'title' => 'TPPS Accession VCF Tree Ids',
    'page callback' => 'tpps_compare_vcf_markers_vs_snps_assay_markers',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    // 'access callback' => 'tpps_access',
    // 'access arguments' => array('access tpps form', 1),
    'type' => MENU_CALLBACK,
  );

  $items['tpps/%/edit-publication'] = array(
    'title' => 'TPPS Edit Publication Information',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_submission_edit_publication', 1),
    'access callback' => 'tpps_access',
    // @TODO Must be 'edit ... submission' permission.
    'access arguments' => array('view own tpps submission', 1),
    'type' => MENU_NORMAL_ITEM,
  );

  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  $items['user/%/tpps'] = array(
    'title' => 'TPPS Submissions',
    'page callback' => 'tpps_tab_create',
    'page arguments' => array(1),
    'access callback' => 'tpps_access',
    'access arguments' => array('user tpps submissions', 1),
    'type' => MENU_LOCAL_TASK,
  );
  // @TODO Change URL to 'tpps/submission/%/delete' to be more REST API.
  // @TODO Major. Very dangerous because allows to remove without confirmation.
  // So XSS could be used to remove any study by sending link to someone who
  // has 'tpps delete submission' permission.
  $items['tpps-submission/%/delete'] = [
    'title' => 'TPPS Delete Submission',
    'type' => MENU_CALLBACK,
    'page callback' => 'tpps_submission_delete_callback',
    'page arguments' => [1],
    'access callback' => 'tpps_access',
    'access arguments' => ['tpps delete submission', 1],
  ];

  $items['completed-submission/%'] = [
    'title' => 'TPPS Completed Submission',
    'page callback' => 'tpps_completed_display',
    'page arguments' => [1],
    'access callback' => 'tpps_access',
    'access arguments' => ['view own tpps submission', 1],
    'type' => MENU_NORMAL_ITEM,
  ];

  $items['tpps-admin-panel'] = array(
    'title' => 'TPPS Admin Panel',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_admin_panel'),
    'access callback' => 'tpps_access',
    'access arguments' => array('approve tpps submissions'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'admin/panel.php',
  );

  $items['tpps-admin-panel/refresh-genotypes-materialized-views'] = array(
    'title' => 'TPPS Refresh Genotypes Materialized Views',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_manage_generate_all_materialized_views', 1),
    'access callback' => 'tpps_access',
    'access arguments' => array('approve tpps submissions'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'admin/panel.php',
  );

  $items['tpps-admin-panel/%'] = array(
    'title' => 'TPPS Admin Panel',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_admin_panel', 1),
    'access callback' => 'tpps_access',
    'access arguments' => array('approve tpps submissions'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'admin/panel.php',
  );


  $items['tpps-admin-panel-logs/%'] = array(
    'title' => 'TPPS Admin Panel',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_admin_panel_logs', 1),
    'access callback' => 'tpps_access',
    'access arguments' => array('approve tpps submissions'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'admin/logs.php',
  );

  // @TODO Minor. Rename menu item. It's a report but not diagnostics.
  // Page shows study's files.
  $items['tpps-admin-panel/file-diagnostics/%'] = [
    'title' => 'Study File Diagnostics',
    'page callback' => 'tpps_admin_files_diagnostics_page',
    'page arguments' => [2],
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'type' => MENU_NORMAL_ITEM,
    'file' => 'admin/pages.php',
  ];

  $items['tpps/doi/%'] = array(
    'title' => 'TPPS DOI',
    'page callback' => 'tpps_manage_doi',
    'page arguments' => [2],
    'access callback' => 'tpps_access',
    'access arguments' => ['access content'],
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/manage_doi.inc',
  );



  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  $items['tpps/autocomplete/%'] = [
    'title' => 'TPPS Autocomplete',
    'description' => 'Autocomplete functions for TPPS module',
    'page callback' => 'tpps_autocomplete',
    'page arguments' => [2],
    'access callback' => 'tpps_access',
    'access arguments' => ['access content'],
    'type' => MENU_NORMAL_ITEM,
    'file' => 'ajax/tpps_ajax.php',
  ];
  /*
   * Ajax Callback for accession coordinates.
   */
  $items['tpps-accession'] = array(
    'title' => 'TPPS Accession coordinates',
    'page callback' => 'tpps_accession_coordinates',
    'access callback' => 'tpps_access',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['tpps-preview-file'] = array(
    'title' => 'TPPS Preview File',
    'page callback' => 'tpps_preview_file',
    'access callback' => 'tpps_access',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['tpps-tag'] = array(
    'title' => 'TPPS Submission Tags',
    'page callback' => 'tpps_submission_tag_manage',
    'access callback' => 'tpps_access',
    'access arguments' => array('administer tpps module'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['tpps-tag/create'] = array(
    'title' => 'Create new TPPS Submission Tag',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_submission_tag_create'),
    'access callback' => 'tpps_access',
    'access arguments' => array('administer tpps module'),
    'type' => MENU_LOCAL_ACTION,
  );

  $items['tpps-tag/edit/%'] = array(
    'title' => 'TPPS Edit Tag',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tpps_submission_tag_edit', 2),
    'access callback' => 'tpps_access',
    'access arguments' => array('administer tpps module'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['tpps-tag/%/%/%'] = array(
    'title' => 'TPPS Add/Remove Tag',
    'page callback' => 'tpps_submission_add_remove_tag',
    'page arguments' => array(1, 2, 3),
    'access callback' => 'tpps_access',
    'access arguments' => array('administer tpps module'),
    'type' => MENU_CALLBACK,
  );

  // [VS].
  tpps_menu_add_detials_pages($items);
  tpps_menu_add_settings_pages($items);
  tpps_menu_add_report_pages($items);
  tpps_menu_add_submission_pages($items);
  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  $items[TPPS_AJAX_URL . '/%'] = [
    // Use POST to send data and GET to just get data.
    'page callback' => 'tpps_ajax_callback',
    'page arguments' => [2],
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    //'delivery callback' => 'ajax_deliver',
    'file' => 'tpps.ajax.inc',
  ];
  // [/VS].
  $items = array_merge($items, tpps_api_paths());
  return $items;
}

/**
 * Implements hook_permission().
 *
 * Defines custom TPPS permissions.
 *
 * @TODO Minor. Implement new permissions.
 *   'view any submission'
 *   'edit own/any submission'
 */
function tpps_permission() {
  return [
    'access tpps form' => [
      'title' => t('Access TPPS Form'),
      'description' => t('Access TPPS Submission form and create submissions.'),
    ],
    'access tpps details' => [
      'title' => t('Access TPPS Details'),
      'description' => t('Access TPPS Complete Submissions Details page.'),
    ],
    'administer tpps module' => [
      'title' => t('Administer TPPS module'),
      'description' => t('Make changes to TPPS configuration.'),
    ],
    'user tpps submissions' => [
      'title' => t('User TPPS Submissions'),
      'description' => t('View all TPPS Submissions for a particular user.'),
    ],
    'approve tpps submissions' => [
      'title' => t('Approve/Reject TPPS submissions'),
      'description' => t('Approve or reject pending TPPS submissions.'),
    ],
    'tpps delete submission' => [
      'title' => t('Delete TPPS submissions'),
      'description' => t('Delete incomplete TPPS submissions.'),
    ],
    'view own tpps submission' => [
      'title' => t('View own TPPS submissions'),
      'description' => t('View TPPS submissions as a particular user.'),
    ],
  ];
}

/**
 * Determine whether the current user has a specific permission.
 *
 * @global stdClass $user
 *   The user in question.
 *
 * @return bool
 *   Whether or not the user has the permission.
 */
function tpps_access() {
  global $user;

  if ($user->uid == 1) {
    return TRUE;
  }

  $args = func_get_args();
  $permission = $args[0] ?? NULL;
  if (gettype($permission) != 'string') {
    return FALSE;
  }

  if (!user_access($permission)) {
    return FALSE;
  }

  switch ($permission) {
    case 'access tpps form':
      $accession = $args[1] ?? NULL;
      if (empty($accession) or $accession == 'new') {
        return TRUE;
      }

      // @TODO Check if it was an attempt to get $_GET['q']?
      $params = drupal_get_query_parameters(NULL, []);
      $path = $params['q'];
      preg_match('/^([^\/]+)\/?.*$/', $path, $matches);
      $form_type = $matches[1] ?? NULL;
      $full_state = tpps_load_submission_state($accession);
      $submission_type = $full_state['tpps_type'] ?? 'tpps';

      if (($submission_info = tpps_load_submission_info($accession))) {
        $type_pass = ($submission_type == $form_type) || preg_match('/^tpps\/TGDR[0-9]+\/.+$/', $path);
        if (
          $submission_info['status'] == "Incomplete"
          && $submission_info['uid'] == $user->uid
          && $type_pass
        ) {
          return TRUE;
        }
      }
      return FALSE;

    case 'user tpps submissions':
      $uid = $args[1] ?? NULL;
      return (!empty($uid) && $uid == $user->uid);

    case 'view own tpps submission':
      $accession = $args[1] ?? NULL;
      // Allow admins to access any study.
      if (user_access('administer tpps module', $user)) {
        return TRUE;
      }
      // Check if user submitted this study.
      if (($submission_info = tpps_load_submission_info($accession))) {
        if (
          $submission_info['status'] != "Incomplete"
          && $submission_info['uid'] == $user->uid
        ) {
          return TRUE;
        }
      }
      return FALSE;

    case 'tpps delete submission':
      $accession = $args[1] ?? NULL;
      if (($submission_info = tpps_load_submission_info($accession))) {
        if (
          $submission_info['status'] == "Incomplete"
          and $user->uid == $submission_info['uid']
        ) {
          return TRUE;
        }
      }
      return FALSE;

    default:
      // @TODO This is unsafe.
      return TRUE;
  }
}

/**
 * Inform Ultimate Cron about cron jobs.
 *
 * Updates TPPS landing page once per day.
 */
function tpps_cronapi() {
  $items = array();

  $freq = variable_get('tpps_latest_job_status_slack_updates_job_frequency', '*/15 * * * *');
  $items['tpps_latest_job_status_slack_updates'] = array(
    'title' => t('TPPS Jobs Slack Updates'),
    'callback' => 'tpps_latest_job_status_slack_updates',
    'scheduler' => array(
      'name' => 'crontab',
      'crontab' => array(
        'rules' => array($freq),
      ),
    ),
  );

  $freq = variable_get('tpps_refresh_views_job_frequency', '0 */12 * * *');
  $items['tpps_refresh_views'] = array(
    'title' => t('Refresh TPPS and CartograPlant views'),
    'callback' => 'tpps_refresh_views',
    'scheduler' => array(
      'name' => 'crontab',
      'crontab' => array(
        'rules' => array($freq),
      ),
    ),
  );



  $freq = variable_get('tpps_refresh_plusgeno_view_frequency', '0 0 * * SAT');
  $items['tpps_refresh_plusgeno_view'] = array(
    'title' => t('Refresh TPPS PlusGeno View (TPPS directory listing)'),
    'callback' => 'tpps_refresh_plusgeno_view',
    'scheduler' => array(
      'name' => 'crontab',
      'crontab' => array(
        'rules' => array($freq),
      ),
    ),
  );

  $freq = variable_get('tpps_delayed_submissions_job_frequency', '0 */6 * * *');
  $items['tpps_delayed_submissions'] = array(
    'title' => t('Check to see if any of the delayed TPPS submissions should be published yet'),
    'callback' => 'tpps_delayed_submissions',
    'scheduler' => array(
      'name' => 'crontab',
      'crontab' => array(
        'rules' => array($freq),
      ),
    ),
  );

  return $items;
}

/**
 * Implements hook_mail().
 *
 * Populates emails for submission status updates.
 * Sends mail to both users and administrators when submissions
 * are completed, rejected, or approved.
 *
 * @param mixed $key
 *   The type of message to send.
 * @param array $message
 *   The skeleton of the message to be sent.
 * @param array $params
 *   The parameters for the message.
 */
function tpps_mail($key, array &$message, array $params) {
  $message['subject'] = $params['subject'] ?? $message['subject'] ?? NULL;
  if (empty($message['subject'])) {
    watchdog('tpps',
      'Email "@key" subject is empty.<pre>@message</pre><pre>@params</pre>',
      [
        '@key' => $key,
        '@message' => print_r($message, 1),
        '@params' => print_r($params, 1),
      ],
      WATCHDOG_ERROR
    );
    return;
  }
  if (!empty($params['body'])) {
    // Note: $params['body'] appends (not replaces).
    $message['body'][] = $params['body'];
  }
  $message['headers'] = array_merge($message['headers'], ($params['headers'] ?? []));
  // Prepare data for email messages.
  $params['type_label'] = $params['type_label'] ?? t('TPPS');
  $link_params = [
    'absulute' => TRUE,
    'attributes' => ['style' => 'text-decoration: underline;'],
  ];
  $site_name = variable_get('site_name', 'TreeGenes');
  $accession = check_plain($params['accession'] ?? NULL);

  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  switch ($key) {
    case 'user_recieved':
      // When the user completes their submission, just provide them with
      // a brief list of the organisms they submitted.
      // See function tpps_submit_email().
      $message['body'][] = t('Congratulations!');
      // @TODO Minor. Probably using new array's element and HTML tag BR will
      // give 2 empty lines instead of just one but some of templates had
      // exactly 2 empty lines. This could be improved later.
      $message['body'][] = '<br />';
      $message['body'][] = '<br />';
      $message['body'][] = t('Your @type_label submission has been received '
        . 'and is pending approval from a TreeGenes administrator! '
        . "Here's a brief summary of the information you provided:",
        ['@type_label' => $params['type_label']]
      );
      // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
      // Build list of organism names.
      for ($i = 1; $i <= $params['organism_number']; $i++) {
        // @TODO Check if other then name information must be used?
        $organism_list[] = t('Organism @number: @name',
          [
            '@number' => $i,
            '@name' => $params['organism_list'][$i]
          ]
        );
      }
      $item_list = [
        t('Primary Author: @author', ['@author' => $params['author'] ?? NULL]),
        t('Publication title: @title', ['@title' => $params['title'] ?? NULL]),
        t('Journal: @journal', ['@journal' => $params['journal'] ?? NULL]),
        t('Number of organisms: @organism_number',
          ['@organism_number' => $params['organism_number']] ?? NULL
        ),
        t('Organisms: !list',
          ['!list' => theme('item_list', ['items' => $organism_list ?? []])]
        ),
        t('Study Type: @study_type',
          ['@study_type' => $params['study_type'] ?? NULL]
        ),
        t('Data Type: @data_type', ['@data_type' => $params['data_type'] ?? NULL]),
      ];
      $message['body'][] = theme('item_list', ['items' => $item_list]);
      // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
      $message['body'][] = t('You can view your submission !link.',
        [
          '!link' => l(t('here'), 'completed-submission/' . $accession,
            $link_params
          ),
        ]
      );
      $message['body'][] = t('If you have any questions about your submission, '
        . 'please feel free to contact us !link.',
        ['!link' => l(t('here'), 'contactform', $link_params)]
      );
      break;

    // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    case 'admin_recieved':
      // When the user completes their submission, notify the admin, and
      // provide them with a link to access the admin panel.
      // See function tpps_submit_email().
      $message['body'][] = t('Attention:');
      $message['body'][] = '<br />';
      $message['body'][] = '<br />';
      $message['body'][] = t('User @user_mail has completed a @type_label '
        . 'Submission, titled "@title".'
        . '<br /><br />'
        . 'Click !link to manage or approve this submission.',
        [
          '@user_mail' => $params['user_mail'],
          '@type_label' => $params['type_label'],
          '@title' => $params['title'],
          '!link' => l(t('here'), 'tpps-admin-panel/' . $accession,
            $link_params
          ),
        ]
      );
      break;

    // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    case 'user_rejected':
      // When the user's submission is rejected, notify them, and provide
      // them with a link to go back and edit their submission. Also
      // provide them with the reason the admin included as to why their
      // submission was rejected.
      $message['body'][] = t('To whom it may concern:');
      $message['body'][] = '<br />';
      $message['body'][] = '<br />';
      $message['body'][] = t('Unfortunately, your submission to @type_label '
        . 'has been rejected. If you would like, you can log into @site_name '
        . 'website and edit your submission !link.',
        [
          '@type_label' => $params['type_label'],
          '@site_name' => t($site_name),
          '!link' => l(t('here'),
            '/user/' . check_plain($params['uid']) . '/tpps',
            $link_params
          ),
        ]
      );
      $message['body'][] = '<br />';
      $message['body'][] = t('The administrator who rejected your '
        . 'submission provided the following reason:');
      // Note: We can't translate reason's text because it's a typed-in text
      // which could be used only once.
      $message['body'][] = '<blockquote>'
        . check_plain($params['reject-reason']) . '</blockquote>';
      break;

    case 'user_approved':
      // When the user's submission is approved, notify them and provide
      // them with the link to view the completed submission.
      $message['body'][] = t('Congratulations! Your submission to '
        . '@site_name has been approved!', ['@site_name' => t($site_name)]
      );
      $message['body'][] = '<br />';
      $message['body'][] = '<br />';
      $message['body'][] = t('You may now refer to your submitted data with '
        . 'accession number @accession.', ['@accession' => $accession]
      );
      $message['body'][] = '<br />';
      $message['body'][] = t('You can still view your submission from !link.',
        [
          '!link' => l(
            t(
              'your @type_label Completed Submissions tab',
              ['@type_label' => $params['type_label']]
            ),
            'completed-submission/' . $accession,
            $link_params
          ),
        ]
      );
      $message['body'][] = '<br />';
      $message['body'][] = t('Your submission should be public on the !link '
        . 'within the next 24 hours.',
        [
          '!link' => l(
            t('@type_label/TGDR Landing Page',
              ['@type_label' => $params['type_label']]
            ),
            // @TODO Minor. Check if both links exist.
            (($params['type'] == 'tpps') ? 'tpps_details/main' : 'tpps/details'),
            $link_params
          ),
        ]
      );
      if ($params['type'] == 'tpps') {
        $message['body'][] = '<br />';
        $message['body'][] = t('To generate a DOI for your submission, '
          . 'please click !link.',
          ['!link' => l(t('here'), 'tpps/doi/' . $accession, $link_params)]
        );
      }
      break;

    default:
      break;
  }
}

/**
 * Implements hook_element_info_alter().
 *
 * Adds process callback tpps_managed_file_process to managed_file elements, and
 * extends the maximum length for textfields.
 */
function tpps_element_info_alter(&$type) {
  if (isset($type['textfield']['#maxlength'])) {
    $type['textfield']['#maxlength'] = 512;
  }
  $type['managed_file']['#process'][] = 'tpps_managed_file_process';
}

/**
 * Extends the managed_file element type.
 *
 * Provides options for users to define the columns in their file, as well as a
 * preview of the first 3 rows of the file.
 *
 * @param array $element
 *   The existing managed_file form element.
 * @param array $form_state
 *   The state of the form.
 * @param array $form
 *   The existing form, including the managed_file element being changed.
 *
 * @return array
 *   The extended managed_file element.
 */
function tpps_managed_file_process(array $element, array &$form_state, array $form) {
  if (!tpps_is_main_form($form_state)) {
    // Only make changes if it is part of the 'tppsc_main' or 'tpps_main' form.
    return $element;
  }

  if (isset($element['columns'])) {
    require_once 'ajax/tpps_ajax.php';
    if (empty($fid = $element['#value']['fid'])) {
      return $element;
    }
    $wrapper = substr($element['#id'], 0, -7) . '-ajax-wrapper';

    $saved_value_parents = $no_header_parents = $element['#parents'];
    $no_header_parents[] = '#value';
    $no_header_parents[] = 'no-header';
    $no_header = drupal_array_get_nested_value(
      $form_state['complete form'],
      $no_header_parents
    );
    $callback = $form_state['triggering_element']['#ajax']['callback'] ?? NULL;
    if (!$no_header && ($callback != 'tpps_no_header_callback')) {
      $end = array_pop($saved_value_parents);
      $saved_value_parents[] = $end . '-no-header';
      $no_header = drupal_array_get_nested_value(
        $form_state['saved_values'][$form_state['stage']],
        $saved_value_parents
      );
    }
    if (!empty($element['no-header'])) {
      $element['no-header'] = [
        '#type' => 'checkbox',
        '#title' => 'My file has no header row',
        '#ajax' => [
          'wrapper' => $wrapper,
          'callback' => 'tpps_no_header_callback',
        ],
        '#states' => $element['#states'] ?? NULL,
        '#default_value' => $no_header ?? NULL,
      ];
    }
    $file = file_load(($fid ?? ''));
    if ($file && ($file->filesize ?? FALSE)) {
      $saved_vals = $form_state['saved_values'][$form_state['stage']];
      $element['columns']['#type'] = 'fieldset';
      $element['columns']['#title'] = t('Define Data');
      $element['columns']['#collapsible'] = TRUE;
      // Stop using the file so it can be deleted if the user clicks 'remove'.
      $accession = substr($form_state['accession'], 4);
      file_usage_delete($file, 'tpps', 'tpps_project', $accession);
      $content = tpps_parse_file($fid, 3, !empty($no_header));
      $options = $element['columns-options']['#value'];
      $first = TRUE;
      foreach ($content['headers'] as $key => $item) {
        $item_parents = $element['#parents'];
        array_pop($item_parents);
        $item_parents[] = end($element['#parents']) . '-columns';
        $item_parents[] = $key;
        $default = drupal_array_get_nested_value($saved_vals, $item_parents);
        if (!isset($default)) {
          foreach ($options as $k => $val) {
            similar_text(strtolower($val), strtolower($item), $percent);
            if ($percent > 85) {
              $default = $k;
              break;
            }
          }
        }
        $item_title = [
          t('Select the type of data column @item holds', ['@item' => $item]),
        ];
        $element['columns'][$key] = [
          '#type' => 'select',
          '#title' => $item,
          '#options' => $options,
          '#default_value' => $default,
          '#prefix' => '<th>',
          '#suffix' => '</th>',
          '#attributes' => [
            'data-toggle' => ['tooltip'],
            'data-placement' => ['top'],
            'title' => $item_title,
          ],
        ];

        if ($first) {
          $first = FALSE;
          $first_col = $key;
        }

        if (!empty($no_header)) {
          $element['columns'][$key]['#title'] = '';
          $element['columns'][$key]['#attributes']['title'] = $item_title;
        }

        if ($form_state['stage'] == TPPS_PAGE_3) {
          $species_num = $element['#parents'];
          array_pop($species_num);
          $species_num = '-' . end($species_num);
          $element['columns'][$key]['#ajax'] = [
            'callback' => 'tpps_accession_pop_group',
            'wrapper' => "population-mapping$species_num",
          ];
        }
      }

      $rows = $content;
      unset($rows['headers']);
      $vars = [
        'header' => $content['headers'],
        'rows' => $rows,
        'attributes' => ['class' => ['view']],
        'caption' => '',
        'colgroups' => NULL,
        'sticky' => FALSE,
        'empty' => '',
      ];
      $table = theme('table', $vars);
      preg_match(
        '/(*UTF8)\A(.*<thead[A-Z|a-z|"|\'|-|_|0-9]*>).*(<\/thead>.*<\/table>)/us',
        $table, $matches
      );

      $element['columns'][$first_col]['#prefix'] =
        "<div style=\"overflow-x:auto\">" . $matches[1] . "<tr>"
        . $element['columns'][$first_col]['#prefix'];
      $element['columns'][$key]['#suffix'] = '</tr>' . $matches[2] . '</div>';
      $element['columns'][$key]['#suffix'] = $element['columns'][$key]['#suffix']
        . t('Please note that if you remain idle on a TPPS page with files '
        . 'for more than 6 hours, you run the risk of having those files '
        . 'reset if you do not click "Save".');
    }
  }

  if (isset($element['empty'])) {
    $element['empty']['#type'] = 'textfield';
    $element['empty']['#title'] = t('File Upload empty field:');
    $element['empty']['#states'] = $element['#states'] ?? NULL;
    $element['empty']['#description'] = t('By default, TPPS will treat  '
      . 'cells with the value "NA" as empty. If you used a different empty '
      . 'value indicator, please provide it here.');
  }
  return $element;
}

/**
 * Implements hook_form_alter().
 *
 * Initializes $form_state['values'] and 'saved_values' to empty arrays,
 * and calls the tpps_leaves(), which populates most default values.
 */
function tpps_form_alter(&$form, &$form_state, $form_id) {
  if (in_array($form['#form_id'], ['tpps_main', 'tppsc_main'])) {
    $stage = $form_state['stage'];
    $form_state['saved_values'][$stage] = $form_state['saved_values'][$stage] ?? [];
    $form_state['values'] = $form_state['values'] ?? [];
    // Initialize default values for each of the leaves in the form tree.
    tpps_leaves($form, $form_state['values'], $form_state['saved_values'][$stage]);
  }
}

/**
 * Populates default values for most form fields.
 *
 * @param array $elements
 *   An array of the elements needing default values.
 * @param array $vals
 *   An array of form_state values.
 * @param array $saved_vals
 *   An array of form_state saved_values.
 */
function tpps_leaves(array &$elements, array $vals, array $saved_vals) {
  foreach ($elements as $key => &$element) {
    if ((gettype($key) != 'string' or $key[0] != '#') and isset($element['#type'])) {
      //if ($key == 'ssrs') {
      //  dpm($element['#tree'], $key . ' tree');
      //  dpm($element['#parents'], $key . ' parents');
      //}

      // If #tree is not set in the current element, and #tree is set and false
      // in the parent element, then set #tree to false in the current element.
      if (
        !isset($element['#tree'])
        // @TODO Variable names are too close. Note: $elements != $element.
        && isset($elements['#tree']) && !$elements['#tree']
      ) {
        $element['#tree'] = FALSE;
      }

      // If #tree is not set or is set to true, then populate the #parents array
      // with the parents of the parent element plus the current key. Otherwise,
      // the #parents array should just be the current key.
      if (empty($element['#parents'])) {
        if (!isset($element['#tree']) || $element['#tree']) {
          $element['#parents'] = array_merge($elements['#parents'], [$key]);
        }
        else {
          $element['#parents'] = [$key];
        }
      }
      else {
        if (end($element['#parents']) != $key) {
          array_push($element['#parents'], $key);
        }
      }
      // Element types that should be loading some default value, usually for
      // the purposes of persistent form data.
      $load_defaults = [
        'textfield',
        'textarea',
        'checkbox',
        'select',
        'managed_file',
      ];
      // If element is a type that should pull from 'saved_values', try to load
      // the old value.
      if (
        in_array($element['#type'], $load_defaults)
        and !isset($element['#default_value'])
        and isset($saved_vals[$key])
      ) {
        $element['#default_value'] = $saved_vals[$key];
      }
      // If element is a select type and still has no default value, then there
      // is no saved value, so the default should be 0.
      elseif (
        $element['#type'] == 'select'
        && !isset($element['#default_value'])
      ) {
        $element['#default_value'] = 0;
      }

      // Checkboxes elements work differently in terms of default values.
      if ($element['#type'] == 'checkboxes') {
        $options = $element['#options'];
        // Get checkboxes options.
        foreach ($options as $option) {
          // If the option does not have a default, pull from 'saved_values'.
          if (
            !isset($element[$option]['#default_value'])
            && isset($saved_vals[$key][$option])
          ) {
            $element[$option]['#default_value'] = $saved_vals[$key][$option];
          }
        }
      }

      if ($element['#type'] == 'fieldset') {
        if (empty($saved_vals[$key]) || !is_array($saved_vals[$key])) {
          $saved_vals[$key] = array();
        }
        if (empty($vals[$key]) || !is_array($vals[$key])) {
          $vals[$key] = array();
        }
        tpps_leaves($element, $vals[$key], $saved_vals[$key]);
      }
    }
  }
}

/**
 * Implements hook_page_build().
 *
 * Adds the side bar to TPPS form pages before they are rendered.
 * Adds the tppsc Status side bar to the page before it is rendered.
 *
 * Note: array $page contains TPPSc/TPPS form array.
 */
function tpps_page_build(&$page) {
  $form_id = $page['content']['system_main']['#form_id'] ?? NULL;
  if (!in_array($form_id, ['tpps_main', 'tppsc_main'])) {
    return $page;
  }

  // Note: Module TPPSc used this check for step value:
  // $page['content']['system_main']['step']['#default_value']
  // but this $page['content']['system_main']['step'] not set even at Page 4.
  $js_settings = drupal_static('drupal_add_js', [])['settings']['data'] ?? [];
  $step = NULL;
  foreach ($js_settings as $info) {
    if (array_key_exists('tpps', $info)) {
      $step = $info['tpps']['stage'] ?? NULL;
      if (!empty($step)) {
        break;
      }
    }
  }
  if (empty($step)) {
    return $page;
  }
  if (!in_array($step, ['frontpage', TPPS_PAGE_1, 'summarypage'])) {
    $blockObject = block_load('views', 'tpps_status');
    $blockObject->title = 'TPPS Status';
    $blockObject->subject = '';
    $blockObject->region = 'Content';
    $block = _block_get_renderable_array(_block_render_blocks([$blockObject]));
    $tpps_status = '<div class="block block-system contextual-links-region '
      . 'block-menu tpps-status-block">'
      . $block['views_tpps_status']['#markup'] . '</div>';
    drupal_add_region_content('sidebar_second', $tpps_status);
  }
  return $page;
}

/**
 * This function creates the main TPPS form.
 *
 * Loads query parameters, ensures the user is logged in, loads old form and
 * form_state information, and calls the appropriate page function.
 *
 * @param array $form
 *   The actual TPPS form.
 * @param array $form_state
 *   The state of the TPPS form - note that this may be overwritten if the user
 *   is loading an old form.
 *
 * @global stdClass $user
 *   The user trying to access the TPPS form.
 *
 * @return array
 *   The created form.
 */
function tpps_main(array $form, array &$form_state, $accession = NULL) {
  global $user;
  require_once 'forms/build/front.php';
  module_load_include('inc', 'tpps', 'includes/form');
  $form = $form ?? [];
  $frontpage_values = $form_state['saved_values']['frontpage'] ?? NULL;
  // JS and CSS.
  tpps_add_css_js('main', $form);
  // Add class to apply CSS rules differntly for TPPS and TPPSc Forms
  // CSS form id is changing because of AJAX requests so we use form's class
  // in CSS rules instead of form's id with regex.
  $form['#attributes']['class'][] = 'tpps-form';



// @TODO We need to convert previous version to latest one here.
// Maybe SIA could be used here as a source of default values.


  // Set version for 'Submission Interface' feature.
  module_load_include('inc', 'tpps', 'includes/submission_form_version');
  tpps_submission_form_version_set($form);

  // Stage/Page.
  if (!isset($form_state['stage'])) {
    if (!isset($accession)) {
      // First access, no accession in link.
      $form_state['stage'] = 'frontpage';

      tpps_front_create_form($form, $form_state);
      return $form;
    }
    else {
      // First access, and with accession in link.
      $old_form_state = tpps_load_submission_state($accession);
      if (empty($old_form_state)) {
        drupal_goto('tpps');
      }
      tpps_form_state_info($form_state, $old_form_state);
    }
  }
  else {
    // Not first access.
    if (
      !isset($frontpage_values['accession'])
      || ($frontpage_values['accession'] ?? NULL) === 'new'
    ) {
      // No submissions, or selected to create new submission.
      if (
        tpps_access('administer tpps module')
        && !empty($frontpage_values['custom_accession_check'])
      ) {
        $accession = $frontpage_values['custom_accession'];
      }
      tpps_init_project($form_state, $accession);
      tpps_create_submission($form_state, $user->uid);
    }
    $old_form_state = tpps_load_submission_state($frontpage_values['accession']);
    if (!empty($old_form_state)) {
      tpps_form_state_info($form_state, $old_form_state);
    }
  }

  if (!isset($form_state['dbxref_id']) or !isset($form_state['accession'])) {
    tpps_init_project($form_state);
  }

  // Accession.
  // Must be after tpps_init_project() which sets accession for new studies.
  $accession = $form_state['accession'] ?? $frontpage_values['accession'] ?? NULL;
  $form['#attached']['js'][] = [
    'data' => [
      'tpps' => [
        'stage' => $form_state['stage'] ?? NULL,
        'accession' => $accession,
      ],
    ],
    'type' => 'setting',
  ];
  // Hidden form accession element.
  // Note: Adding this elements to $form heare require all sub-functions to
  // use reference and not return $form array.
  $form['accession'] = ['#type' => 'hidden', '#value' => $accession];

  module_load_include('inc', 'tpps', 'includes/status_bar');
  tpps_status_bar($form, $form_state);

  $page1_values = $form_state['saved_values'][TPPS_PAGE_1] ?? [];
  if (
    !isset($page1_values['primaryAuthor'])
    && ($form_state['tpps_type'] ?? NULL) != 'tppsc'
  ) {
    $contact_bundle = tripal_load_bundle_entity(['label' => 'Tripal Contact Profile']);
    if ($contact_bundle) {
      $query = new EntityFieldQuery();
      $results = $query->entityCondition('entity_type', 'TripalEntity')
        ->entityCondition('bundle', $contact_bundle->name)
        ->fieldCondition('local__email', 'value', $user->mail)
        ->range(0, 1)
        ->execute();
      if (!empty($results['TripalEntity'])) {
        $entity = current(array_reverse(entity_load('TripalEntity',
          array_keys($results['TripalEntity']))));
        $form_state['saved_values'][TPPS_PAGE_1]['primaryAuthor']
          = $form_state['saved_values'][TPPS_PAGE_1]['primaryAuthor'] ?? $entity->title;
      }
    }
  }

  switch ($form_state['stage']) {
    case TPPS_PAGE_1:
      module_load_include('php', 'tpps', 'forms/build/page_1');
      tpps_page_1_create_form($form, $form_state);
      break;

    case TPPS_PAGE_2:
      module_load_include('php', 'tpps', 'forms/build/page_2');
      tpps_page_2_create_form($form, $form_state);
      break;

    case TPPS_PAGE_3:
      module_load_include('php', 'tpps', 'forms/build/page_3');
      tpps_page_3_create_form($form, $form_state);
      break;

    case TPPS_PAGE_4:
      module_load_include('php', 'tpps', 'forms/build/page_4');
      tpps_page_4_create_form($form, $form_state);
      break;

    case 'summarypage':
      module_load_include('php', 'tpps', 'forms/build/summary');
      tpps_summary_create_form($form, $form_state);
      break;

    default:
      drupal_set_message(t('Invalid form stage.'), 'error');
      break;
  }
  return $form;
}

/**
 * Implements hook_form_validate().
 *
 * Validates input to form. Also saves file column information so it is not lost
 * if the input is not valid.
 */
function tpps_main_validate(&$form, &$form_state) {
  global $user;

  if (
    $form_state['triggering_element']['#value'] == 'Back'
    or $form_state['triggering_element']['#value'] == 'Save'
  ) {
    tpps_save_file_columns($form, $form_state);
    return;
  }

  switch ($form_state['stage']) {
    case 'frontpage':
      require_once 'forms/validate/front.php';
      tpps_front_page_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_1:
      require_once 'forms/validate/page_1.php';
      tpps_page_1_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_2:
      require_once 'forms/validate/page_2.php';
      tpps_page_2_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_3:
      require_once 'forms/validate/page_3.php';
      tpps_page_3_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_4:
      require_once 'forms/validate/page_4.php';
      tpps_page_4_validate_form($form, $form_state);
      break;

    default:
      break;
  }

  if ($user->uid !== 0 and !form_get_errors()) {
    $form_state['values']['#cleared'] = TRUE;
    if ($form_state['submitted'] == '1') {
      tpps_submission_update_stats($form_state);
    }
  }
  else {
    $form_state['values']['#cleared'] = FALSE;
  }
}

/**
 * Implements hook_form_submit().
 *
 * This function handles the multi-step aspect of the form, as well as saving
 * input to persistent variables so they can be reloaded later.
 *
 * @TODO Minor. Check if files of old submission are removed
 * when existing TGDR reused.
 */
function tpps_main_submit($form, &$form_state) {
  $saved_values = &$form_state['saved_values'] ?? NULL;
  $values = &$form_state['values'] ?? NULL;
  module_load_include('inc', 'tpps', 'includes/submission_file');

  // Set Submission Form Version.
  module_load_include('inc', 'tpps', 'includes/submission_form_version');
  $form_state['saved_values'][TPPS_SUBMISSION_FORM_VERSION_KEY] =
    $form_state['saved_values'][TPPS_SUBMISSION_FORM_VERSION_KEY]
    ?? $form_state['values'][TPPS_SUBMISSION_FORM_VERSION_KEY] ?? 1;
  unset($form_state['values'][TPPS_SUBMISSION_FORM_VERSION_KEY]);

  // We need to label all study files as temporary to avoid problems with
  // page navigation when 'Back' button was used.
  if (
    $form_state['stage'] == 'frontpage'
    && strpos(($values['accession'] ?? NULL), 'TGDR') !== FALSE
  ) {
    // @TODO Minor. Check case when old TGDR reused it will be overwritten.
    // Could we skip file status changing?
    // && !$form_state['values']['use_old_tgdr']
    $state = tpps_submission_get_state($values['accession']);
    tpps_submission_file_set_status($state, 0);
  }
  // We need to change status of files when user clicked 'Back' or 'Next'
  // buttons to avoid errors and allow to edit study.
  if (in_array($form_state['triggering_element']['#value'], ['Back', 'Next'])) {
    tpps_submission_file_set_status($form_state, 0);
  }
  $saved_values[$form_state['stage']] = $values;
  $persist = TRUE;

  // This happens when the user clicks Save, notice this if clause will do a return.
  // This means after saving, the form will be rebuilt based on the rebuild key = TRUE.
  if ($form_state['triggering_element']['#value'] == 'Save') {
    drupal_set_message(t('Your information has been saved!'), 'status');
    if (isset($saved_values['form_build_id'])) {
      $values['form_build_id'] = $saved_values['form_build_id'];
    }
    $saved_values['form_build_id'] = $values['form_build_id'];
    $form_state['rebuild'] = TRUE;
    tpps_update_submission_state($form_state);
    // File status must not be changed here because we need to have termporary
    // status of file until study completely submitted. See 'summarypage'
    // processing.
    // tpps_submission_file_set_status($form_state, FILE_STATUS_PERMANENT);
    cache_clear_all('*', (TPPS_CACHE_BIN ?? 'cache'), TRUE);
    return;
  }

  // ELSE, it will do the below logic, read the comment after this switch statement.
  switch ($form_state['stage']) {
    case 'frontpage':
      $persist = FALSE;
      $form_state['stage'] = TPPS_PAGE_1;
      break;

    case TPPS_PAGE_1:
      $form_state['stage'] = TPPS_PAGE_2;
      break;

    case TPPS_PAGE_2:
      if ($form_state['triggering_element']['#value'] == 'Back') {
        // [VS]
        // This is not required but to have always up-to-date form fields
        // values which could be modified on validation step.
        $form_state['rebuild'] = TRUE;
        // [/VS]
        $form_state['stage'] = TPPS_PAGE_1;
      }
      else {
        $form_state['stage'] = TPPS_PAGE_3;
      }
      break;

    case TPPS_PAGE_3:
      if ($form_state['triggering_element']['#value'] == 'Back') {
        // [VS]
        // This is not required but to have always up-to-date form fields
        // values which could be modified on validation step.
        $form_state['rebuild'] = TRUE;
        // [/VS]
        $form_state['stage'] = TPPS_PAGE_2;
      }
      else {
        $form_state['stage'] = TPPS_PAGE_4;
      }
      break;

    case TPPS_PAGE_4:
      if ($form_state['triggering_element']['#value'] == 'Back') {
        // [VS]
        // This is not required but to have always up-to-date form fields
        // values which could be modified on validation step.
        $form_state['rebuild'] = TRUE;
        // [/VS]
        $form_state['stage'] = TPPS_PAGE_3;
      }
      else {
        $form_state['stage'] = 'summarypage';
      }
      break;

    case 'summarypage':
      if ($form_state['triggering_element']['#value'] == 'Back') {
        // [VS]
        // On validation metadata field or file could be update so
        // we need to update form.
        $form_state['rebuild'] = TRUE;
        // [/VS]
        $form_state['stage'] = TPPS_PAGE_4;
      }
      else {
        $accession = $form_state['accession'];
        $form_state['status'] = 'Pending Approval';
        $form_state['completed'] = time();
        tpps_submission_file_set_status($form_state, FILE_STATUS_PERMANENT);
        tpps_update_submission_state($form_state);
        // Save Submission Info.
        tpps_update_submission_info(
          $accession, ['status' => $form_state['status']]
        );
        // Save Submission Interface Array.
        // Note:
        // We don't use tpps_submission_interface_new($accession)
        // because $form_state has most recent changes and we could
        // avoid extra DB query here.
        $interface = tpps_submission_interface_generate($form_state);
        tpps_submission_interface_save($interface);

        tpps_submit_email($form_state);
        drupal_goto('completed-submission/' . $accession);
        return;
      }
      break;

    default:
      drupal_set_message(t('Invalid form stage.'), 'error');
      break;
  }

  // It'll then come here and also perform a save most likely
  // which I think will cater for NEXT button.
  if (isset($saved_values['form_build_id'])) {
    $values['form_build_id'] = $saved_values['form_build_id'];
  }
  $saved_values['form_build_id'] = $values['form_build_id'];
  $form_state['rebuild'] = TRUE;

  if ($persist) {
    tpps_update_submission_state($form_state);
  }
  if ($form_state['stage'] == TPPS_PAGE_1) {
    // When non-empty (after Page1 submit) study was added we need to
    // reset cached lists of accessions.
    // Note: We must clear cache when submission already stored to DB.
    cache_clear_all('*', (TPPS_CACHE_BIN ?? 'cache'), TRUE);
  }
}

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

/**
 * Provides the form based on which step the user is on.
 *
 * @param array $form
 *   The form to be created.
 * @param array $form_state
 *   The state of the form to be created.
 *
 * @return array
 *   Returns the completed form.
 */
function tppsc_main(array $form, array &$form_state, $accession = NULL) {
  global $user;
  module_load_include('inc', 'tpps', 'includes/form');
  // Get the query parameters from the url.
  $params = drupal_get_query_parameters();

  // [VS].
  tpps_add_css_js('main', $form);
  // Add class to apply CSS rules differntly for TPPS and TPPSc Forms
  // CSS form id is changing because of AJAX requests so we use form's class
  // in CSS rules instead of form's id with regex.
  $form['#attributes']['class'][] = 'tppsc-form';



// @TODO Major. We need to convert previous version to latest one here.
// Maybe SIA could be used here as a source of default values.



  // Set version for 'Submission Interface' feature.
  module_load_include('inc', 'tpps', 'includes/submission_form_version');
  tpps_submission_form_version_set($form);

  // User not logged in, trying to access front page.
  if (!isset($user->mail) and !isset($form_state['stage'])) {
    $form_state['stage'] = 'frontpage';

    // Create front page.
    module_load_include('php', 'tpps', 'forms/build/front');
    tpps_front_create_form($form, $form_state);
    return $form;
  }
  // User not logged in, trying to access non-front page.
  elseif (!isset($user->mail)) {
    $destination = drupal_get_destination();
    drupal_goto('user/login', array('query' => $destination));
  }
  // User logged in, trying to load form from existing accession.
  elseif (isset($accession) and !isset($form_state['stage'])) {
    $old_form_state = tpps_load_submission_state($accession);
    tpps_form_state_info($form_state, $old_form_state);
  }
  // User logged in, no accession provided.
  else {
    if (!isset($form_state['stage'])) {
      $form_state['stage'] = 'frontpage';

      // Create the front page.
      module_load_include('php', 'tpps', 'forms/build/front');
      tpps_front_create_form($form, $form_state);
      return $form;
    }
    else {
      if (
        !isset($form_state['saved_values']['frontpage']['accession'])
        or (
          isset($form_state['saved_values']['frontpage']['accession'])
          and $form_state['saved_values']['frontpage']['accession'] === 'new'
        )
      ) {
        // Initialize project.
        tpps_init_project($form_state);
        tpps_create_submission($form_state, $user->uid);
      }
      $old_form_state = tpps_load_submission_state($form_state['saved_values']['frontpage']['accession']);
      tpps_form_state_info($form_state, $old_form_state);
    }
  }

  // Hidden form accession element.
  // Note: Adding this elements to $form heare require all sub-functions to
  // use reference and not return $form array.
  // @TODO [VS] Use common function which called from subfunctions to add
  // common elements instead of pass $form by reference.
  $form['accession'] = [
    '#type' => 'hidden',
    '#value' => $form_state['accession'],
  ];

  if (!isset($form_state['dbxref_id']) or !isset($form_state['accession'])) {
    tpps_init_project($form, $form_state);
  }

  $form_state['tpps_type'] = 'tppsc';
  tpps_update_submission_state($form_state);
  if (variable_get('tpps_top_bar', 'status') == 'status') {
    module_load_include('inc', 'tpps', 'includes/status_bar');
    tpps_status_bar($form, $form_state);
  }
  else {
    tpps_form_navigation_bar($form, $form_state);
  }

  switch ($form_state['stage']) {
    case TPPS_PAGE_1:
      module_load_include('php', 'tpps', 'forms/build/page_1');
      tpps_page_1_create_form($form, $form_state);
      break;

    case TPPS_PAGE_2:
      module_load_include('php', 'tpps', 'forms/build/page_2');
      tpps_page_2_create_form($form, $form_state);
      break;

    case TPPS_PAGE_3:
      module_load_include('php', 'tpps', 'forms/build/page_3');
      tpps_page_3_create_form($form, $form_state);
      break;

    case TPPS_PAGE_4:
      module_load_include('php', 'tpps', 'forms/build/page_4');
      tpps_page_4_create_form($form, $form_state);
      break;

    case 'summarypage':
      module_load_include('php', 'tpps', 'forms/build/summary');
      tpps_summary_create_form($form, $form_state);
      break;

    default:
      drupal_set_message(t('Invalid form stage.'), 'error');
      break;
  }
  return $form;
}

/**
 * Form validator for 'tppsc_main' form.
 *
 * Calls different validation functions based on the stage of the form. Also
 * saves file column data and add attributes to be used by the status bar where
 * appropriate.
 */
function tppsc_main_validate(array &$form, array &$form_state) {
  // If the user is going backwards or simply saving their data in the form,
  // make sure to save the column data for the managed_file elements. The rest
  // of the validation function does not need to be completed.
  if (in_array($form_state['triggering_element']['#value'], ['Back', 'Save'])) {
    tpps_save_file_columns($form, $form_state);
    return;
  }
  // Call the appropriate validation function based on the form stage.
  switch ($form_state['stage']) {
    case 'frontpage':
      if ($form_state['values']['use_old_tgdr'] and !$form_state['values']['old_tgdr']) {
        form_set_error('old_tgdr', 'Existing TGDR number: field is required.');
      }
      break;

    case TPPS_PAGE_1:
      module_load_include('php', 'tpps', 'forms/validate/page_1');
      tpps_page_1_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_2:
      module_load_include('php', 'tpps', 'forms/validate/page_2');
      tpps_page_2_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_3:
      module_load_include('php', 'tpps', 'forms/validate/page_3');
      tpps_page_3_validate_form($form, $form_state);
      break;

    case TPPS_PAGE_4:
      module_load_include('php', 'tpps', 'forms/validate/page_4');
      tpps_page_4_validate_form($form, $form_state);
      break;

    default:
      break;
  }
  // [VS].
  $module_path = drupal_get_path('module', 'tpps');
  $form['#attached']['js'][] = $module_path . TPPS_JS_PATH;
  // [/VS].
  // If there were no errors in validating the input, then let the form status
  // bar know that those fields are cleared to be shown.
  if (!form_get_errors()) {
    $form_state['values']['#cleared'] = TRUE;
    if ($form_state['submitted'] == '1') {
      tpps_submission_update_stats($form_state);
    }
  }
  // Otherwise, do not show the values for this page.
  else {
    $form_state['values']['#cleared'] = FALSE;
  }
}

/**
 * Implements hook_FORM_ID_submit().
 *
 * Calls different submission functions based on the stage of the form. Also
 * copies the form values into the form saved values so they can be seen by the
 * other pages and the final submit functions. Sets the incomplete form state
 * variable in the database so that it can be loaded later. If the form was
 * completed, notifies the user that their submission was received.
 *
 * @param array $form
 *   The form being submitted.
 * @param array $form_state
 *   The associated state of the form being submitted.
 */
function tppsc_main_submit($form, &$form_state) {
  global $user;
  module_load_include('inc', 'tpps', 'includes/submission_file');
  $form_state['status'] = 'Incomplete';

  // Set Submission Form Version.
  module_load_include('inc', 'tpps', 'includes/submission_form_version');
  $form_state['saved_values'][TPPS_SUBMISSION_FORM_VERSION_KEY] =
    $form_state['values'][TPPS_SUBMISSION_FORM_VERSION_KEY] ?? 1;
  unset($form_state['values'][TPPS_SUBMISSION_FORM_VERSION_KEY]);

  if ($form_state['stage'] == 'frontpage' and $form_state['values']['use_old_tgdr']) {
    $form_state['dbxref_id'] = $form_state['values']['old_tgdr'];
    $form_state['accession'] = chado_select_record('dbxref', array('accession'), array(
      'dbxref_id' => $form_state['dbxref_id'],
    ))[0]->accession;
    $form_state['values']['accession'] = $form_state['accession'];
    $form_state['status'] = 'Incomplete';
    tpps_create_submission($form_state, $user->uid);
    tpps_submission_file_set_status($form_state, 0);
    tpps_main_submit($form, $form_state);
    tpps_update_submission_state($form_state);
    tpps_update_submission_info($form_state['accession'],
      ['status' => $form_state['status']]
    );
    return;
  }

  if ($form_state['stage'] != 'summarypage') {
    tpps_main_submit($form, $form_state);
  }
  else {
    $accession = $form_state['accession'];
    $form_state['saved_values'][$form_state['stage']] = $form_state['values'];
    $persist = TRUE;

    if ($form_state['triggering_element']['#value'] == 'Back') {
      $form_state['stage'] = TPPS_PAGE_4;
    }
    else {
      $form_state['status'] = 'Pending Approval';
      $form_state['completed'] = time();
      tpps_submission_file_set_status($form_state, FILE_STATUS_PERMANENT);
      tpps_update_submission_state($form_state);
      // Update Submission Info.
      tpps_update_submission_info(
        $accession, ['status' => $form_state['status']]
      );
      // Save Submission Interface Array.
      // Note:
      // We don't use tpps_submission_interface_new($accession)
      // because $form_state has most recent changes and we could
      // avoid extra DB query here.
      $interface = tpps_submission_interface_generate($form_state);
      tpps_submission_interface_save($interface);

      tpps_submit_email($form_state);
      drupal_goto('completed-submission/' . $accession);
      return;
    }

    if (isset($form_state['saved_values']['form_build_id'])) {
      $form_state['values']['form_build_id'] = $form_state['saved_values']['form_build_id'];
    }
    $form_state['saved_values']['form_build_id'] = $form_state['values']['form_build_id'];
    $form_state['rebuild'] = TRUE;

    if ($persist) {
      tpps_update_submission_state($form_state);
    }



// @TODO Add to TPPS also.



  // Note:
  // We shouldn't generate new Submission Interface Array (SIA) each time
  // Form State Array is saved (or updated) because if study was processed
  // already then SIA could contain extra data (like ids and etc.) added
  // during processing by submit_all.php script.
  // That's why we need to merge changes from $form_state with existing SIA.
  $submission_interface = array_merge(
    tpps_submission_interface_load($accession, RESET_CACHE),
    tpps_submission_interface_generate($form_state)
  );
  db_update('tpps_submission')
    ->fields([
      'submission_state' => serialize($form_state),
      'submission_interface' => serialize([]),
    ])
    ->condition('accession', $accession)
    ->execute();
  // Reset cache.
  }
}

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

/**
 * Implements hook_block_view_alter().
 *
 * This function populates the TPPS Status Bar block with data that has already
 * been collected through the form.
 */
function tpps_block_view_alter(&$data, $block) {
  global $base_url;
  switch ($block->delta) {
    case 'tpps_status':
      $css = "
      .tgdr_status_block img {
          vertical-align: middle;
          margin-bottom: 4px;
          margin-right: 2px;
      }
      ";
      drupal_add_css($css, 'inline');

      $data['subject'] = t('TPPS Status');
      $content = "<div class='tgdr_status_block'>";
      $params = drupal_get_query_parameters(NULL, array());
      if (preg_match('/tppsc?\/(TGDR.*)/', $params['q'], $matches)) {
        $accession = $matches[1];
        $form_state = tpps_load_submission_state($accession);
      }
      elseif (isset($_REQUEST['accession'])) {
        $accession = $_REQUEST['accession'];
        $form_state = tpps_load_submission_state($accession);
      }
      else {
        $content .= '</div>';
        $data['content'] = filter_xss($content);
        break;
      }
      $ok = "<img src='$base_url/misc/message-16-ok.png'>";
      $form_state['saved_values'][TPPS_PAGE_2]['study_info'] = NULL;
      $flat = tpps_flatten($form_state);

      $map_api_key = variable_get('tpps_maps_api_key', NULL);
      foreach ($flat as $item => $val) {
        if ($item[0] !== '#') {
          $item_str = filter_xss(check_plain($item));
          $val_str = filter_xss(check_plain($val));
          if (preg_match('/(Abstract|Organization)/', $item)) {
            continue;
          }
          elseif (preg_match('/File/', $item) and ($file_name = file_load($val)->filename)) {
            // Create links to files.
            $file_url = check_plain(file_create_url(file_load($val)->uri));
            $val_str = "<a href='$file_url' target='blank'>$file_name</a>";
            if (!$flat['#skip_loc'] and preg_match('/^(.*)Accession File/', $item, $matches)) {
              $fid = $val;
              $wrapper_id = "{$fid}_map_wrapper";
              $button_id = "{$fid}_map_button";
              $val_str .= "<div id=\"$wrapper_id\"></div>"
                . "<input id=\"$button_id\" type=\"button\" value=\"Click "
                . "here to view plants on map!\"></input>";
              $form['#attached']['js'][] = [
                'type' => 'setting',
                'data' => [
                  'tpps' => [
                    'map_buttons' => [
                      $fid => [
                        'wrapper' => $wrapper_id,
                        'button' => $button_id,
                        'fid' => $fid,
                      ],
                    ],
                  ],
                ],
              ];
            }
          }
          elseif (preg_match('/species photo/', $item) and (file_load($val)) and ($file_name = file_load($val)->filename)) {
            $file_url = check_plain(file_create_url(file_load($val)->uri));
            $val_str = "<img src='$file_url' width='100%'>";
            $val_str .= "<br><a href='$file_url' target='blank'>$file_name</a>";
          }
          elseif (preg_match('/Month/', $item)) {
            // Skip experiment start/end month.
            continue;
          }
          elseif (preg_match('/^(.*)Year/', $item, $matches)) {
            // Combine experiment start/end month + year.
            if (isset($flat[$matches[1] . 'Month'])) {
              $item_str = $matches[1] . 'Date';
              $val_str = "{$flat[$matches[1] . 'Month']} $val_str";
            }
            else {
              continue;
            }
          }
          elseif (preg_match('/Study Location/', $item) and isset($flat['#location_type']) and $flat['#location_type']) {
            // Add map capability to location.
            if ($flat['#location_type'] == '2') {
              $query = $val_str;
            }
            elseif ($flat['#location_type'] != '2' and ($standard = tpps_standard_coord($val_str))) {
              $query = $standard;
            }
            $val_str = "<a id=\"sidebar_map\" style=\"cursor:pointer\">$val_str</a>";
            if (isset($query) and !empty($map_api_key)) {
              $map = "<iframe frameborder=\\\"0\\\" style=\\\"border:0;width:100%;height:100%\\\" src=\\\"https://www.google.com/maps?q=$query&output=embed&key=$map_api_key&z=5\\\" allowfullscreen> </iframe></div>";
              $js = "jQuery(document).ready(function ($) {
                jQuery(\"#sidebar_map\").click(function() {
                  jQuery(\"#sidebar_map_wrapper\").remove();
                  jQuery(\"#sidebar_map\").after( \"<br><div id=\\\"sidebar_map_wrapper\\\">$map</div>\" );
                });
              });";
              drupal_add_js($js, 'inline');
            }
          }
          elseif (
            preg_match('/Publication DOI/', $item)
            || preg_match('/Dataset DOI/', $item)
          ) {
            $link = preg_match('/https?:\/\//', $val_str) ? $val_str : "https://doi.org/$val_str";
            $val_str = "<a href=\"$link\" target=\"blank\">$val_str</a>";
          }
          $content .= "$ok $item_str: $val_str <br>";
        }
        elseif (preg_match('/#page_(.)_cleared/', $item, $matches)) {
          // Break between pages.
          if ($val) {
            $step_arr = array(
              1 => 'Author and Species Information',
              2 => 'Experimental Conditions',
              3 => 'Plant Accession',
              4 => 'Submit Data',
            );
            if ($matches[1] > 1) {
              $content .= '<br />';
            }
            $content .= "$ok Step {$matches[1]} - Complete<br />{$step_arr[$matches[1]]}<br /><hr />";
          }
          else {
            // If page not cleared, do not display remaining form state data.
            break;
          }
        }
        elseif (preg_match('/^#(.*)accession_(.*)/', $item, $matches)) {
          $val_str = filter_xss(check_plain($val));
          $parts = explode(" ", substr($matches[0], 1));
          $item_id = implode("_", $parts);
          $content .= "<div id=\"$item_id\" style=\"display:none;\">$val_str</div>";
        }
      }
      if (!empty($flat['#page_3_cleared']) and !empty($map_api_key)) {
        $content .= "<script src=\"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js\"></script><script src=\"https://maps.googleapis.com/maps/api/js?key=$map_api_key&callback=initMap\"
        async defer></script>";
      }
      $content .= "</div>";
      $data['content'] = $content;

      break;

    default:
      break;
  }
}

/**
 * Implements hook_media_browser_plugins_alter().
 */
function tpps_media_browser_plugins_alter(&$plugins) {
  unset($plugins['upload']);
  unset($plugins['media_default--media_browser_my_files']);
}

// WARNING: Required because dev-server has PHP 7.0.2.
//
// There are several ways to provide this functionality for versions
// prior to PHP 7.3.0. It is possible to use array_keys(),
// but that may be rather inefficient.
// It is also possible to use reset() and key(),
// but that may change the internal array pointer.
// An efficient solution, which does not change the internal
// array pointer, written as polyfill.
if (!function_exists('array_key_first')) {

  /**
   * Polifill for array_key_first() implemented in PHP 7.3.0 and higher.
   *
   * @param array $arr
   *   Array to be processed.
   *
   * @return string
   *   Returns key of the first element of the given array.
   */
  function array_key_first(array $arr) {
    foreach ($arr as $key => $unused) {
      return $key;
    }
    return NULL;
  }

}

// WARNING: Required because dev-server has PHP 7.0.2.
//
// See https://www.php.net/manual/en/function.array-key-last.php#124007
if (!function_exists('array_key_first')) {

  /**
   * Polifill for array_key_last() implemented in PHP 7.3.0 and higher.
   *
   * @param array $arr
   *   Array to be processed.
   *
   * @return string
   *   Returns key of the last element of the given array.
   */
  function array_key_first(array $arr) {
    foreach ($arr as $key => $unused) {
      return $key;
    }
  }

}

/**
 * Implements hook_init().
 *
 * Removed (but not fixed!) spam message:
 *   Notice: Undefined variable: show_nafgs_menu in include() (line 147 of
 *   /var/www/Drupal/sites/all/themes/sites/all/themes/dawn/tpl/page.tpl.php).
 */
function tpps_init() {
  if (!empty($_SESSION['messages']['error'])) {
    $spam = 'Undefined variable: show_nafgs_menu in';
    foreach ($_SESSION['messages']['error'] as $index => $item) {
      if (strpos($item, $spam)) {
        unset($_SESSION['messages']['error'][$index]);
      }
    }
    if (empty($_SESSION['messages']['error'])) {
      unset($_SESSION['messages']['error']);
    }
  }
}

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
// Custom Cache Bin.

/**
 * Implements hook_drush_cache_clear().
 */
function tpps_drush_cache_clear(&$types) {
  $types['tpps'] = '_tpps_cache_clear';
}

/**
 * Utility function that clears all the entries in our cache bin.
 */
function _tpps_cache_clear() {
  cache_clear_all('*', (TPPS_CACHE_BIN ?? 'cache'), TRUE);
}

/**
 * Implements hook_flush_caches().
 */
function tpps_flush_caches() {
  return [TPPS_CACHE_BIN];
}

/**
 * Adds CSS and JS files to page.
 *
 * 1. Theme styles will be loaded in any case.
 * 2. We add both CSS and JS even if only one is required because it's better
 *    for caching system to have less unique pages and more pages with the
 *    same set of attached files.
 *
 * @param mixed $page_id
 *   When string it could be a 'theme', 'main' or a page name.
 *   When integer it's TPPS Form Page Id.
 *
 *   What is $page_id?
 *                      | $page_id     | CSS       | JS        | File                          |
 *   -------------------+--------------+-----------+-----------+-------------------------------+
 *   Theme              | 'theme'      | Yes       | No        | /css/theme/<name>.css         |
 *   TPPS main CSS/JS   | 'main'       | Yes       | Yes       | /css/tpps.css                 |
 *   Specific Page Id   | $page_number | If exists | If exists | /css/tpps_page_${page_id}.css |
 *   Specific Page Name | $page_name   | If exists | If exists | /css/tpps_${page_name}.css    |
 *
 *   Constants like TPPS_PAGE_1 and etc could be used to improve code readablility.
 *   Custom Page Id like 'study_export' for 'TPPS Study Export Page'.
 *
 * @param array $form
 *   Drupal Form API form array.
 *   When NULL then CSS/JS will be added as it's a regular page.
 *
 *   To force using Form API instead of use drupal_add_css/js():
 *     $form = $form ?? [];
 *     tpps_add_css_js('main', $form);
 *   This could be useful if $form not yet defined at the beginning of the
 *   form generation callback.
 *
 * @TODO Minor. Get Form Id from the $form and use as a file name.
 */
function tpps_add_css_js($page_id = 'main', array &$form = NULL) {
  // Custom CSS Theme.
  $theme_path = TPPS_MODULE_PATH . '/css/themes/'
    . variable_get('tpps_theme', 'default') . '.css';
  module_load_include('inc', 'tpps', 'includes/common');
  $dark_theme_path = TPPS_MODULE_PATH . '/css/dark_theme.css';
  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  // This is regualar page.
  if ($form === NULL || !is_array($form)) {
    drupal_add_css($theme_path);
    if (variable_get('tpps_dark_theme')) {
      drupal_add_css($dark_theme_path);
    }
    if ($page_id == 'theme') {
      // We only add theme.
      return;
    }
    if ($page_id == 'main') {
      // Add main files.
      drupal_add_css(TPPS_MODULE_PATH . TPPS_CSS_PATH);
      drupal_add_js(TPPS_MODULE_PATH . TPPS_JS_PATH);
      if (variable_get('tpps_theme_fix_pager')) {
        drupal_add_css(TPPS_MODULE_PATH . '/css/pager_fix.css');
      }
    }
    else {
      // Add custom page files. Like 'TPPS Study Export Page' and 'study_export'.
      drupal_add_css(TPPS_MODULE_PATH . '/css/tpps_' . $page_id . '.css');
      drupal_add_js(TPPS_MODULE_PATH . '/js/tpps_' . $page_id . '.js');
    }
  }
  else {
    // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    // This is form.
    $form['#attached']['css'][] = $theme_path;
    if (variable_get('tpps_dark_theme')) {
      $form['#attached']['css'][] = $dark_theme_path;
    }
    if ($page_id == 'theme') {
      // We only add theme.
      return;
    }
    if ($page_id == 'main') {
      // Add main files.
      $form['#attached']['js'][] = [
        'type' => 'file',
        'scope' => 'footer',
        'group' => JS_THEME,
        'data' => TPPS_MODULE_PATH . TPPS_JS_PATH,
      ];
      $form['#attached']['css'][] = TPPS_MODULE_PATH . TPPS_CSS_PATH;
      if (variable_get('tpps_theme_fix_pager')) {
        $form['#attached']['css'][] = TPPS_MODULE_PATH . '/css/pager_fix.css';
      }
    }
    elseif ($page_id && is_numeric($page_id) && $page_id > 0) {
      // This it TPPS Page. Add page specific files.
      $form['#attached']['js'][] = [
        'type' => 'file',
        'scope' => 'footer',
        'group' => JS_THEME,
        'data' => TPPS_MODULE_PATH . '/js/tpps_page_' . $page_id . '.js',
      ];
      $form['#attached']['css'][] = TPPS_MODULE_PATH
        . '/css/tpps_page_' . $page_id . '.css';
    }
  }
}

/**
 * Adds module settings pages for hook_menu().
 *
 * @param array $items
 *   Menu items.
 */
function tpps_menu_add_settings_pages(array &$items = []) {
  $items = $items ?? [];
  $items['admin/config/tpps'] = [
    'title' => 'TPPS',
    'description' => 'TPPS Settings',
    'position' => 'right',
    'weight' => -10,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => ['access administration pages'],
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  ];
  $items['admin/config/tpps/main'] = [
    'title' => 'Main Settings',
    'description' => 'Main module settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_admin_settings'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/config.php',
  ];
  $items['admin/config/tpps/form'] = [
    'title' => 'Form',
    'description' => 'Form Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_form_main_settings_form'],
    'access arguments' => ['administer tpps module'],
    'file' => 'admin/form_main.inc',
    'weight' => 10,
  ];
  $items['admin/config/tpps/form/main'] = [
    'title' => 'Main',
    'description' => 'Form Main Settings',
    'weight' => 10,
    'file path' => TPPS_MODULE_PATH,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  ];
  $items['admin/config/tpps/form/front'] = [
    'title' => 'Front',
    'description' => 'Form Front page Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_form_front_settings_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/form_front.inc',
    'weight' => 20,
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/config/tpps/form/page-1'] = [
    'title' => 'Page 1',
    'description' => 'Form Page 1 Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_form_page_1_settings_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/form_page_1.inc',
    'weight' => 30,
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/config/tpps/form/page-4'] = [
    'title' => 'Page 4',
    'description' => 'Form Page 4 Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_form_page_4_settings_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/form_page_4.inc',
    'weight' => 100,
    'type' => MENU_LOCAL_TASK,
  ];

  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  // Synonym.
  $items['admin/config/tpps/synonym'] = [
    'title' => 'Synonym',
    'description' => 'Synonym/Unit Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_synonym_add_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/synonym.inc',
    'weight' => 100,
  ];
  $items['admin/config/tpps/synonym/add'] = [
    'title' => 'Add Synonym',
    'description' => 'Create new Phenotype Synonym',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  ];
  $items['admin/config/tpps/synonym/rebuild'] = [
    'title' => 'Rebuild',
    'description' => 'Reset cached Synonym and Unit lists',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_synonym_list_rebuild_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/synonym.inc',
    'type' => MENU_LOCAL_TASK,
  ];
  // ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  // Submit All.
  $items['admin/config/tpps/submit-all'] = [
    'title' => 'Submit All',
    'description' => 'Tripal Job Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submit_all_settings_form'],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'admin/submit_all.inc',
  ];
}

/**
 * Adds report menu items for hook_menu().
 *
 * See function tpps_reports_overview_page() for a list of items.
 *
 * @param array $items
 *   Menu items.
 */
function tpps_menu_add_report_pages(array &$items = []) {
  $items = $items ?? [];
  $items['admin/reports/tpps'] = [
    'title' => 'TPPS Reports',
    'description' => 'TPPS module reports',
    'page callback' => 'tpps_reports_overview_page',
    'access arguments' => ['administer tpps module'],
  ];
  // [VS] Synonym and Unit reports.
  $items['admin/reports/tpps/unit-warning'] =
  $items['tpps-admin-panel/reports/unit-warning'] = [
    'title' => variable_get('tpps_report_unit_warning_title',
      'Unit Warning (list of phenotypes which unit differs from Synonym)'),
    'description' => "List of Phenotypes which differs from Synonym's Unit.",
    'page callback' => 'tpps_admin_unit_warning_report',
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'file' => 'reports/unit_warning.inc',
  ];
  // No synonym.
  $items['admin/reports/tpps/no-synonym'] =
  $items['tpps-admin-panel/reports/no-synonyms'] = [
    'title' => variable_get('tpps_report_no_synonym_title',
      'List of phenotypes without Synonyms'),
    'description' => "List of phenotypes without synonym.",
    'page callback' => 'tpps_admin_no_synonym_report',
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'file' => 'reports/no_synonym.inc',
  ];
  // Order/Family Exist Report.
  $items['admin/reports/tpps/order-family-not-exist'] =
  $items['tpps-admin-panel/reports/order-family-not-exist'] = [
    'title' => variable_get('tpps_report_order_family_not_exist_title',
      'Order/Family not exist'),
    'description' => "Lists non-existing order/family.",
    'page callback' => 'tpps_admin_order_family_not_exist_report',
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'file' => 'reports/order_family_not_exist.inc',
  ];
  // Missing DOI reports.
  $items['admin/reports/tpps/missing-doi'] =
  $items['tpps-admin-panel/reports/missing-doi'] = [
    'title' => variable_get('tpps_report_missing_doi_title', 'Missing DOI'),
    'description' => 'List of Studies without DOI attached.',
    'page callback' => 'tpps_missing_doi_report',
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'file' => 'reports/missing_doi.inc',
  ];
  // Imported Studies.
  $items['admin/reports/tpps/imported-studies'] =
  $items['tpps-admin-panel/reports/imported-studies'] = [
    'title' => 'Imported Studies',
    'description' => 'List of Imported Studies Accessions.',
    'page callback' => 'tpps_admin_imported_studies_report',
    'access callback' => 'tpps_access',
    'access arguments' => ['administer tpps module'],
    'file' => 'reports/imported_studies.inc',
  ];
}

/**
 * Adds Submission Import/Export pages into hook_menu().
 *
 * @param array $items
 *   Menu items.
 */
function tpps_menu_add_submission_pages(array &$items = []) {
  $items = $items ?? [];
  // List of all submissions and action-buttons.
  $items['tpps/submission'] = [
    'title' => 'Submission',
    'description' => 'TPPS Submission Migraiton',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_list_form'],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/list.inc',
  ];
  $items['tpps/submission/%'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2],
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_list_form', 2],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/list.inc',
  ];
  // View.
  $items['tpps/submission/%/view'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'View TPPS Submission',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_view_form', 2],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/view.inc',
  ];
  // Export.
  $items['tpps/submission/%/export'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'Export of TPPS Submission',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_export_form', 2],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/export.inc',
  ];
  $items['tpps/submission/%/import'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'Import of TPPS Submission',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_import_form', 2],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'pages/submission/import.inc',
  ];
  // Manual Export.
  $items['tpps/submission/%/manual_export'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'Manual Export of TPPS Submission',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_manual_export_form', 2],
    'access arguments' => ['administer tpps module'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'pages/submission/manual_export.inc',
  ];
  // Compare.
  $items['tpps/submission/%/compare'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'Compare two TPPS Submissions',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_compare_form', 2],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/compare.inc',
  ];
  $items['tpps/submission/%/compare/%'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3, 4],
    'description' => 'Comparison of two TPPS Submissions',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_compare', 2, 4],
    'access arguments' => ['administer tpps module'],
    'file' => 'pages/submission/compare.inc',
  ];

  $items['tpps/submission/%/purge'] = [
    'title callback' => 'tpps_submission_title',
    'title arguments' => [2, 3],
    'description' => 'Purge TPPS Submission',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['tpps_submission_purge_form', 2],
    'access arguments' => ['tpps delete submission'],
    'file path' => TPPS_MODULE_PATH,
    'file' => 'pages/submission/purge.inc',
  ];
}

/**
 * Menu callback. Shows list of TPPS Reports.
 *
 * See function tpps_menu_add_report_pages();
 */
function tpps_reports_overview_page() {
  return theme('item_list', [
    'title' => t('TPPS Reports'),
    'items' => [
      l(t('Unit Warning Report'), 'admin/reports/tpps/unit-warning'),
      l(t('No Synonym Report'), 'admin/reports/tpps/no-synonym'),
      l(t('Order/Family Exist Report'), 'admin/reports/tpps/order-family-not-exist'),
      l(t('Missing DOI Report'), 'admin/reports/tpps/missing-doi'),
      l(t('Imported Studies'), 'admin/reports/tpps/imported-studies'),
    ],
  ]);
}

/**
 * Menu callback. Shows list of Submission operations.
 *
 * Used by tpps_details_tab($accession, $type);
 */
function tpps_submission_overview_page() {
  return theme('item_list', [
    'title' => t('The TPPS Submission operations'),
    'items' => [
      l(t('Export'), 'admin/config/tpps/submission/export'),
      l(t('Import'), 'admin/config/tpps/submission/import'),
      l(t('Manual Export'), 'admin/config/tpps/submission/manual_export'),
      l(t('Compare'), 'admin/config/tpps/submission/compare'),
      l(t('View'), 'admin/config/tpps/submission/view'),
      l(t('Purge'), 'admin/config/tpps/submission/purge'),
    ],
  ]);
}

/**
 * Dynamyc menu item titles for TPPS Submisssion pages.
 *
 * @param string $accession
 *   Study Accession.
 * @param string $op
 *   Operation.
 * @param string $extra
 *   Extra data.
 *
 * @return string
 *   Returns menu item title.
 */
function tpps_submission_title($accession = '', $op = '', $extra = '') {
  return t('Submission @accession @op @extra',
    [
      '@op' => ucfirst($op ?? NULL),
      '@accession' => $accession ?? NULL,
      '@extra' => ($extra ? 'with ' . $extra : ''),
    ]
  );
}

/**
 * Adds Submission Import/Export pages into hook_menu().
 *
 * @param array $items
 *   Menu items.
 */
function tpps_menu_add_detials_pages(array &$items = []) {
  $items = $items ?? [];
  $items['tpps/details'] = [
    'title' => 'TPPS Details',
    'page callback' => 'tpps_details_list',
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps details'],
    'type' => MENU_NORMAL_ITEM,
  ];
  // This is actually an AJAX-callback which used to repload pages on page
  // 'tpps/details'. Seems it's a custom pager and could be replaced with
  // default pager but there is also filter form at page and this probably
  // was the reason why AJAX content reloading was used.
  $items['tpps/details/top'] = [
    'title' => 'TPPS Details List Callback',
    'page callback' => 'tpps_details_top_callback',
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps details'],
    'type' => MENU_CALLBACK,
  ];
  $items['tpps/details/%'] = [
    'title' => 'TPPS Details',
    'page callback' => 'tpps_details',
    'page arguments' => [2],
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps details'],
    'type' => MENU_NORMAL_ITEM,
  ];
  // AJAX-callback for Tabs. See /js/tpps.js function detailsTab().
  $items['tpps/details/%/%'] = [
    'title' => 'TPPS Details Tab Callback',
    'page callback' => 'tpps_details_tab',
    // 1st is accession, 2nd is tab machine name.
    'page arguments' => [2, 3],
    'access callback' => 'tpps_access',
    'access arguments' => ['access tpps details'],
    'type' => MENU_CALLBACK,
  ];
}

/**
 * Checks if Form's Id is 'tppsc_main' or 'tpps_main'.
 *
 * @param array $form_state
 *   Drupal From API State array.
 *
 * @return bool
 *   Returns TRUE if given $form_state belongs to one on forms processed by
 *   this module ('tppsc_main' or 'tpps_main'). Returns FALSE otherwise.
 */
function tpps_is_main_form(array $form_state) {
  return in_array(
    $form_state['build_info']['form_id'] ?? NULL,
    ['tppsc_main', 'tpps_main']
  );
}
